
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>Michael-J</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Michael Jiang">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="Michael-J">
<meta property="og:url" content="http://michael-j.net/page/4/index.html">
<meta property="og:site_name" content="Michael-J">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Michael-J">

    
    <link rel="alternative" href="/atom.xml" title="Michael-J" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Michael-J" title="Michael-J"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Michael-J">Michael-J</a></h1>
				<h2 class="blog-motto">一个修行路上的码农</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:michael-j.net">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/19/Debug-Tomcat-deploy-twice/" title="Btrace Sample Scripts" itemprop="url">Btrace Sample Scripts</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2015-10-19T09:16:28.000Z" itemprop="datePublished"> Published 2015-10-19</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="https://kenai.com/projects/btrace/pages/Home" target="_blank" rel="noopener">Btrace</a> is very powerful tool for online debugging, here is the sample scripts in tar btrace.</p>
<p>The scripts are very useful, so I decide to upload them. Here is the scripts below:</p>
<ul>
<li>AWTEventTracer.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-AWTEventTracer.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-AWTEventTracer.java</a></li>
<li>AllCalls1.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllCalls1.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllCalls1.java</a></li>
<li>AllCalls1Sampled.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllCalls1Sampled.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllCalls1Sampled.java</a></li>
<li>AllCalls2.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllCalls2.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllCalls2.java</a></li>
<li>AllCalls2Sampled.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllCalls2Sampled.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllCalls2Sampled.java</a></li>
<li>AllCalls3.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllCalls3.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllCalls3.java</a></li>
<li>AllCalls3Sampled.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllCalls3Sampled.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllCalls3Sampled.java</a></li>
<li>AllLines.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllLines.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllLines.java</a></li>
<li>AllMethods.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllMethods.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllMethods.java</a></li>
<li>AllMethodsSampled.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllMethodsSampled.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllMethodsSampled.java</a></li>
<li>AllSync.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllSync.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-AllSync.java</a></li>
<li>ArgArray.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-ArgArray.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-ArgArray.java</a></li>
<li>Classload.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-Classload.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-Classload.java</a></li>
<li>CommandArg.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-CommandArg.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-CommandArg.java</a></li>
<li>DTraceInline.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-DTraceInline.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-DTraceInline.java</a></li>
<li>DTraceRefDemo.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-DTraceRefDemo.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-DTraceRefDemo.java</a></li>
<li>Deadlock.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-Deadlock.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-Deadlock.java</a></li>
<li>FileTracker.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-FileTracker.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-FileTracker.java</a></li>
<li>FinalizeTracker.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-FinalizeTracker.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-FinalizeTracker.java</a></li>
<li>HistoOnEvent.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-HistoOnEvent.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-HistoOnEvent.java</a></li>
<li>Histogram.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-Histogram.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-Histogram.java</a></li>
<li>HistogramBean.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-HistogramBean.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-HistogramBean.java</a></li>
<li>JInfo.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-JInfo.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-JInfo.java</a></li>
<li>JMap.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-JMap.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-JMap.java</a></li>
<li>JStack.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-JStack.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-JStack.java</a></li>
<li>JdbcQueries.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-JdbcQueries.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-JdbcQueries.java</a></li>
<li>LogTracer.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-LogTracer.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-LogTracer.java</a></li>
<li>MemAlerter.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-MemAlerter.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-MemAlerter.java</a></li>
<li>Memory.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-Memory.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-Memory.java</a></li>
<li>MultiClass.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-MultiClass.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-MultiClass.java</a></li>
<li>NewArray.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-NewArray.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-NewArray.java</a></li>
<li>NewComponent.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-NewComponent.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-NewComponent.java</a></li>
<li>OnThrow.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-OnThrow.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-OnThrow.java</a></li>
<li>ProbeExit.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-ProbeExit.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-ProbeExit.java</a></li>
<li>Profiling.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-Profiling.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-Profiling.java</a></li>
<li>Sizeof.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-Sizeof.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-Sizeof.java</a></li>
<li>SocketTracker.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-SocketTracker.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-SocketTracker.java</a></li>
<li>SocketTracker1.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-SocketTracker1.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-SocketTracker1.java</a></li>
<li>SubtypeTracer.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-SubtypeTracer.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-SubtypeTracer.java</a></li>
<li>SysProp.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-SysProp.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-SysProp.java</a></li>
<li>Test.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-Test.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-Test.java</a></li>
<li>ThreadBean.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-ThreadBean.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-ThreadBean.java</a></li>
<li>ThreadCounter.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-ThreadCounter.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-ThreadCounter.java</a></li>
<li>ThreadCounterBean.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-ThreadCounterBean.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-ThreadCounterBean.java</a></li>
<li>ThreadStart.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-ThreadStart.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-ThreadStart.java</a></li>
<li>Timers.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-Timers.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-Timers.java</a></li>
<li>URLTracker.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-URLTracker.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-URLTracker.java</a></li>
<li>WebServiceTracker.java : <a href="http://7xnmye.com1.z0.glb.clouddn.com/btrace-WebServiceTracker.java" target="_blank" rel="noopener">http://7xnmye.com1.z0.glb.clouddn.com/btrace-WebServiceTracker.java</a></li>
</ul>
<p>You can access them with curl or wget, wish you happy debugging!</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/debug/">debug</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/btrace/">btrace</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/17/利用Autoconfig打包Java-WEB应用/" title="利用Autoconfig打包Java WEB应用" itemprop="url">利用Autoconfig打包Java WEB应用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2015-10-17T06:39:08.000Z" itemprop="datePublished"> Published 2015-10-17</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>简介： 本文主要介绍常用的后台应用打包的几种方式</p>
<p>后端应用上线前都需要经过重新打包，可千万别小看了这个阶段，这个是非常非常重要的！如果打错了包或者使用错了配置文件，结果可能是毁灭性的！</p>
<p>我们都知道每个软件项目或者公司都会维护几套隔离环境，例如以前在阿里就会有<code>日常测试</code>、<code>日常</code>、<code>预发</code>和<code>线上</code>几个环境，还有根据特殊需要配置的独立环境，如<code>性能环境</code>等等。 当然，对于小公司或者创业公司来说不需要准备这么多套环境，但至少是需要<code>测试</code>和<code>线上</code>两套环境的。多套环境的可以有效的隔离线上和线下，提高开发人员的工作效率，又不至于将不稳定的代码带到线上。其中最重要的一个环节就是打包，我主要介绍两种简单的打包方式。</p>
<h2 id="利用Spring配置"><a href="#利用Spring配置" class="headerlink" title="利用Spring配置"></a>利用Spring配置</h2><p>现在Java WEB应用可以说90%都使用了Spring框架，而Spring框架早就帮我们考虑了这个问题。我一开始也是使用这个配置方式，在Spring配置文件中引入一下配置：</p>
<blockquote>
<p>&lt;context:property-placeholder location=”file:${APP_HOME}/config.properties”/&gt;</p>
</blockquote>
<p>Spring是支持classpath和file的，个人推荐使用<code>file</code>模式来查找外部配置文件，因为这样我们就不必将配置文件引入到工程目录中了，因为工程目录对所有的开发人员都可见，这样会降低配置文件的安全性。引入外部配置文件一个常见的做法就是使用环境变量，我们新建一个<code>APP_HOME</code>的环境变量来区分不同的环境。</p>
<p>在使用配置文件的地方利用placeholder进行配置即可，例如以下方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;dataSource&quot; class=&quot;org.apache.commons.dbcp2.BasicDataSource&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;driverClassName&quot; value=&quot;$&#123;db.driverClass&#125;&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;url&quot; value=&quot;$&#123;db.url&#125;&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;username&quot; value=&quot;$&#123;db.username&#125;&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;password&quot; value=&quot;$&#123;db.password&#125;&quot;/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
<p>在Spring启动以后，它会去查找你配置的外部配置文件，并逐个替换使用的配置中的placeholder。</p>
<p>这种方式的优点就是简单，灵活，但是缺点也是很明显的：</p>
<ul>
<li><p>只支持Spring配置文件的替换，不支持其他框架配置文件的替换。<br> 如果你想替换logback.xml中的某个配置，例如日志输出目录或者日志输出级别，它是做不到的。</p>
</li>
<li><p>大规模部署不方便。<br>如果只有一两机器这样部署还是比较方便的，但是如果有几十台甚至上百台这样打包就十分麻烦了。如果改动一个配置项，就需要保持所有机器的同步的，所以一般大一点的公司都会有专门负责配置的服务，例如阿里的ConfigServer。</p>
</li>
</ul>
<h2 id="利用AutoConfig打包"><a href="#利用AutoConfig打包" class="headerlink" title="利用AutoConfig打包"></a>利用AutoConfig打包</h2><p>AutoConfig 是阿里内部使用的一个打包工具，十分方便，也十分强大，这里有它的介绍：<a href="http://openwebx.org/docs/autoconfig.html" target="_blank" rel="noopener">http://openwebx.org/docs/autoconfig.html</a></p>
<p>下面是我利用AutoConfig打包的步骤：</p>
<ul>
<li><p>添加不同环境的配置</p>
<p>为了直接利用Maven打出不同环境的包，我们在需要打包的module的pom中添加下面的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">      &lt;autoconfig.properties&gt;antx.properties.dev&lt;/autoconfig.properties&gt;</span><br><span class="line">      &lt;env&gt;dev&lt;/env&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>然后加入profile配置：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;profiles&gt;</span><br><span class="line">       &lt;profile&gt;</span><br><span class="line">           &lt;!-- 本地开发环境 --&gt;</span><br><span class="line">           &lt;id&gt;dev&lt;/id&gt;</span><br><span class="line">           &lt;properties&gt;</span><br><span class="line">               &lt;autoconfig.properties&gt;antx.properties.dev&lt;/autoconfig.properties&gt;</span><br><span class="line">               &lt;env&gt;dev&lt;/env&gt;</span><br><span class="line">           &lt;/properties&gt;</span><br><span class="line">       &lt;/profile&gt;</span><br><span class="line">       &lt;profile&gt;</span><br><span class="line">           &lt;!-- 测试环境 --&gt;</span><br><span class="line">           &lt;id&gt;test&lt;/id&gt;</span><br><span class="line">           &lt;properties&gt;</span><br><span class="line">               &lt;autoconfig.properties&gt;antx.properties.test&lt;/autoconfig.properties&gt;</span><br><span class="line">               &lt;env&gt;test&lt;/env&gt;</span><br><span class="line">           &lt;/properties&gt;</span><br><span class="line">       &lt;/profile&gt;</span><br><span class="line">       &lt;profile&gt;</span><br><span class="line">           &lt;!-- 生产环境 --&gt;</span><br><span class="line">           &lt;id&gt;online&lt;/id&gt;</span><br><span class="line">           &lt;properties&gt;</span><br><span class="line">               &lt;autoconfig.properties&gt;antx.properties.online&lt;/autoconfig.properties&gt;</span><br><span class="line">               &lt;env&gt;online&lt;/env&gt;</span><br><span class="line">           &lt;/properties&gt;</span><br><span class="line">       &lt;/profile&gt;</span><br><span class="line">   &lt;/profiles&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>添加autoconfig maven插件支持</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> &lt;plugin&gt;</span><br><span class="line">	&lt;groupId&gt;com.alibaba.citrus.tool&lt;/groupId&gt;</span><br><span class="line">          &lt;artifactId&gt;autoconfig-maven-plugin&lt;/artifactId&gt;</span><br><span class="line"> 	&lt;version&gt;1.2&lt;/version&gt;</span><br><span class="line">	&lt;configuration&gt;</span><br><span class="line">               	&lt;userProperties&gt;$&#123;user.home&#125;/conf/$&#123;autoconfig.properties&#125;&lt;/userProperties&gt;</span><br><span class="line">	&lt;/configuration&gt;</span><br><span class="line">	&lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;autoconfig&lt;/goal&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                    &lt;/execution&gt;</span><br><span class="line">	&lt;/executions&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p> 其中,userProperties属性就是我们使用的配置文件。</p>
<ul>
<li><p>利用Maven进行打包</p>
<p>进入到需要打包的module中，然后执行<code>mvn package -P&lt;env&gt;</code>，其中env代表不同的环境，在上面的配置中env只能为dev、test和online.<br>我们可以将最终的包名也带上环境名称，以区分打出来的不同环境的包，如下配置：</p>
</li>
</ul>
<p><code>&lt;finalName&gt;包名-${env}&lt;/finalName&gt;</code></p>
<h3 id="Tips"><a href="#Tips" class="headerlink" title="Tips:"></a>Tips:</h3><p>如果开发人员使用的是jetty插件来进行本地开发的，那么需要将jetty:run改为jetty:run-war，因为autoconfig是需要执行package才会进行触发的，而jetty:run不会执行package阶段。可以参考一下配置：</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- jetty插件 --&gt;</span><br><span class="line"> &lt;plugin&gt;</span><br><span class="line">     &lt;groupId&gt;org.mortbay.jetty&lt;/groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;jetty-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">     &lt;version&gt;7.6.16.v20140903&lt;/version&gt;</span><br><span class="line">     &lt;configuration&gt;</span><br><span class="line">         &lt;webAppSourceDirectory&gt;src/main/webapp&lt;/webAppSourceDirectory&gt;</span><br><span class="line">         &lt;scanIntervalSeconds&gt;3&lt;/scanIntervalSeconds&gt;</span><br><span class="line">         &lt;connectors&gt;</span><br><span class="line">             &lt;connector implementation=&quot;org.eclipse.jetty.server.nio.SelectChannelConnector&quot;&gt;</span><br><span class="line">                 &lt;port&gt;8080&lt;/port&gt;</span><br><span class="line">                 &lt;maxIdleTime&gt;60000&lt;/maxIdleTime&gt;</span><br><span class="line">             &lt;/connector&gt;</span><br><span class="line">         &lt;/connectors&gt;</span><br><span class="line">         &lt;war&gt;target/包名-$&#123;env&#125;.war&lt;/war&gt;</span><br><span class="line">     &lt;/configuration&gt;</span><br><span class="line"> &lt;/plugin&gt;</span><br></pre></td></tr></table></figure>
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/部署/">部署</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/java/">java</a><a href="/tags/package/">package</a><a href="/tags/autoconfig/">autoconfig</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/05/30/Java也能玩转WebSocket/" title="Java也能玩转WebSocket" itemprop="url">Java也能玩转WebSocket</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2015-05-30T00:00:00.000Z" itemprop="datePublished"> Published 2015-05-30</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><strong><em>本篇介绍使用Netty来实现Websocket，为实践篇，不涉及原理性讨论。</em></strong></p>
<h4 id="1-什么是Websocket"><a href="#1-什么是Websocket" class="headerlink" title="1. 什么是Websocket?"></a>1. 什么是Websocket?</h4><p>  <a href="http://zh.wikipedia.org/wiki/WebSocket" target="_blank" rel="noopener">WebSocket</a> 是H5提供的一个基于TCP链接全双工的通信协议，可以简单HTTP协议的长链接升级版。</p>
<p> 为什么要用websocket、使用websocket的好处已经websocket的原理这里就不再赘述了，上面的两篇文章都介绍的非常清楚了。</p>
<h4 id="2-准备工作"><a href="#2-准备工作" class="headerlink" title="2. 准备工作"></a>2. 准备工作</h4><ul>
<li><p>升级Nginx</p>
<p>Nginx从1.3.13版本开始支持WebSocket协议，由于集团里面使用的是Tengine，所以需要先查看Tengine版本号。使用下面命令即可：</p>
<p><code>/home/admin/cai/bin/nginx-proxy -v</code></p>
<p>执行完后发现：Tengine version: Tengine/1.4.6 (nginx/1.2.9) ，nginx版本太低。升级Tengine就行，较新的Tengine都以支持Websocket.</p>
<p>升级Tengine命令执行：<code>sudo yum install -b current tengine</code> 会安装最新版的Tengine。</p>
<p>安装配置的过程还是由很多坑的。</p>
<p>接下来就是配置nginx了，配置很简单，按照一下配置即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location /chat/ &#123;</span><br><span class="line">  proxy_pass http://127.0.0.1:9999/;</span><br><span class="line">  proxy_http_version 1.1;</span><br><span class="line">  proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">  proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你想更加灵活的配置可参考: <a href="http://nginx.org/en/docs/http/websocket.html" target="_blank" rel="noopener">http://nginx.org/en/docs/http/websocket.html</a></p>
<p>最后，重新加载nginx配置就可以了，<code>sudo sh nginxctl reload</code>。</p>
</li>
<li><p>升级WEB容器</p>
<p>这一步并不是必须的，如果你使用的Websocket的实现依赖于WEB容器，那么就必须升级WEB容器来支持。</p>
<p>JSR356规范制定了Websocket的标准，只要是实现了JSR356规范的容器均支持Websocket。Tomcat从7.0.47版本开始支持JSR356标准，并且要求JDK版本至少为1.7。</p>
<p>由于升级WEB容器带来的变化太多，本人并没有采用这种方式。</p>
</li>
</ul>
<h4 id="3-Java对Websocket的支持"><a href="#3-Java对Websocket的支持" class="headerlink" title="3. Java对Websocket的支持"></a>3. Java对Websocket的支持</h4><ul>
<li><p>JavaEE 7开始全面支持Websocket协议</p>
<p>Spring4.0才实现了JavaEE 7标准，那么如果希望Spring直接支持Websocket协议，那么必须将Spring升级到4.0以上。使用Spring框架来支持Websocket的好处就是可以使用它大量的注解和服务，而且可以很好的与现有业务相结合。</p>
</li>
<li><p>WEB容器对Websocket的支持</p>
<p>前面提到了JSR356标准指定了Websocket规范，在这个标准出来后很多WEB容器都纷纷实现了该标准，以支持Websocket。该阶段处于Websocket的初期，各个容器的实现方式也各不相同，如果不想升级到Spring4而又想使用Websocket，那么就可以利用容器的特性了。<br>如果你有这方面的需求可以参考：<br><a href="http://blog.fens.me/java-websocket-intro" target="_blank" rel="noopener">http://blog.fens.me/java-websocket-intro</a> 、<a href="http://redstarofsleep.iteye.com/blog/1488639" target="_blank" rel="noopener">http://redstarofsleep.iteye.com/blog/1488639</a></p>
</li>
<li><p>利用Netty来实现Websocket</p>
<p><a href="http://netty.io/" target="_blank" rel="noopener">Netty</a>是一个Java语言实现的非常高效的基于事件的网络库，感谢师兄告诉我这个框架。我也是刚接触这个框架不久，原理我就不谈了。如果你有Linux下的开发经验一定对这种框架不会陌生，这些框架的底层都经历了select\poll到epoll的转变，在Linux下有Libev\Libevent之类相似的框架，以及Node底层的Libuv也是如此，这方面的资料也是非常多的。</p>
<p>我们要用Netty是不仅是因为它是一个高效的网络库，而且它还是实现了很过高层的网络协议，其中就包括Websocket。Netty对Websocket有很好的支持，而且它对Websocket的处理是原生的，不依赖于底层容器，那么我们就可以在不升级底层容器已经改变Spring框架的基础上来编写基于Websocket的应用了。</p>
</li>
</ul>
<h4 id="4-Netty来创建Websocket链接"><a href="#4-Netty来创建Websocket链接" class="headerlink" title="4. Netty来创建Websocket链接"></a>4. Netty来创建Websocket链接</h4><ul>
<li><p>启动Websocket服务器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketServer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> EventLoopGroup workGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> ChannelPipelineInitializer channelPipelineInitializer;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(WebSocketServer.class);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      InnerWebSocketServer wsServer = <span class="keyword">new</span> InnerWebSocketServer();</span><br><span class="line">      <span class="keyword">new</span> Thread(wsServer).start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPort</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.port = port;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">InnerWebSocketServer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">              serverBootstrap.group(workGroup).channel(NioServerSocketChannel.class)</span><br><span class="line">                      .childHandler(channelPipelineInitializer);</span><br><span class="line">              ChannelFuture future = serverBootstrap.bind(<span class="keyword">new</span> InetSocketAddress(<span class="string">"127.0.0.1"</span>,port)).syncUninterruptibly();</span><br><span class="line">              logger.info(<span class="string">"WebSocket Server is running on "</span> + future.channel().localAddress());</span><br><span class="line">              future.channel().closeFuture().sync();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">              logger.error(<span class="string">"Start Websocket error:&#123;&#125;."</span>,e.getMessage(),e);</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">              workGroup.shutdownGracefully();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong><em>Tips:注意为了让Netty在Spring初始化的时候启动，我指定了init方法为这个bean的初始化方法。而Netty的监听方法是一个同步调用(sync方法),这会阻碍Spring继续初始化，导致初始化失败。所以我在初始化方法中启动了另外一个线程来完成WebsocketServer的初始化。</em></strong></p>
<ul>
<li><p>注册处理Pipeline</p>
<p>Netty的处理请求的方式与Webx的很相似，连名字都叫Pipeline。我们先要注册一系列的Handler来完成对一个Websocket的请求的处理，类似于Spring里面Interceptor的概念。</p>
</li>
</ul>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Component</span></span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChannelPipelineInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt; </span>&#123;</span><br><span class="line"> 	  <span class="meta">@Resource</span></span><br><span class="line">   	<span class="keyword">private</span> WebSocketFrameHandler webSocketFrameHandler;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">   	<span class="keyword">private</span> HttpRequestHandler httpRequestHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">   	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       	ChannelPipeline pipeline=ch.pipeline();</span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> HttpServerCodec());</span><br><span class="line">   	    pipeline.addLast(<span class="keyword">new</span> HttpObjectAggregator(<span class="number">64</span>*<span class="number">1024</span>));</span><br><span class="line">       	pipeline.addLast(httpRequestHandler);</span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> WebSocketServerProtocolHandler(<span class="string">"/ws/"</span>));</span><br><span class="line">   	    pipeline.addLast(webSocketFrameHandler);</span><br><span class="line">   	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> <strong><em>Tips:httpRequestHandler和websocketFrameHandler是自己实现的处理Handler。前者会负责对请求做一些基本校验已经获取SESSION的动作，而后者是则是消息处理的Handler，实现了各种事件的处理逻辑，也是跟业务紧密相关的地方。</em></strong></p>
<ul>
<li><p>实现WebSocketFrameHandler</p>
<p>一般情况下我们只用实现<code>SimpleChannelInboundHandler</code>就可以了.</p>
</li>
</ul>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Component</span></span><br><span class="line"> <span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketFrameHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> WebSocketHandlerFactory webSocketHandlerFactory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(WebSocketFrameHandler.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        WebSocketHandler handler = getWebSocketHandlerByChannel(ctx.channel());</span><br><span class="line">        <span class="keyword">if</span> (handler != <span class="keyword">null</span>)</span><br><span class="line">            handler.read(ctx, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.channelInactive(ctx);</span><br><span class="line">        logger.info(<span class="string">"Client "</span> + ctx.channel() + <span class="string">" disconnected!"</span>);</span><br><span class="line">        getWebSocketHandlerByChannel(ctx.channel()).disconnect(ctx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.channelActive(ctx);</span><br><span class="line">        WebSocketHandler handler = getWebSocketHandlerByChannel(ctx.channel());</span><br><span class="line">        <span class="keyword">if</span> (handler != <span class="keyword">null</span>)</span><br><span class="line">            handler.connect(ctx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (evt == WebSocketServerProtocolHandler.ServerHandshakeStateEvent.HANDSHAKE_COMPLETE) &#123;</span><br><span class="line">            logger.info(<span class="string">"Client "</span> + ctx.channel() + <span class="string">" connected!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        logger.error(<span class="string">"Caught WebSocket Error,error:&#123;&#125;."</span>, cause.getMessage(), cause.getStackTrace());</span><br><span class="line">        <span class="keyword">super</span>.exceptionCaught(ctx, cause);</span><br><span class="line">        WebSocketHandler handler = getWebSocketHandlerByChannel(ctx.channel());</span><br><span class="line">        <span class="keyword">if</span> (handler != <span class="keyword">null</span>)</span><br><span class="line">            handler.caughtException(ctx, cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> WebSocketHandler <span class="title">getWebSocketHandlerByChannel</span><span class="params">(Channel channel)</span> </span>&#123;</span><br><span class="line">        String topic = channel.attr(WebSocketConstants.TOPIC).get();</span><br><span class="line">        WSTopicIdentify topicIdentify = WSTopicIdentify.getTopicFromValue(topic);</span><br><span class="line">        <span class="keyword">if</span> (topicIdentify == WSTopicIdentify.UNKNOWN)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> (WebSocketHandler&lt;ChannelHandlerContext, Object&gt;) webSocketHandlerFactory.getWebSocketHandler(topicIdentify);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> <strong><em>Tips:为了让Websocket与具体业务分离，建议对不同的业务实现自己的WebsocketHandler,而这里总的handler根据业务的标识符路由到不同的业务handler即可。</em></strong></p>
<h4 id="5-让Netty更好的于业务结合"><a href="#5-让Netty更好的于业务结合" class="headerlink" title="5. 让Netty更好的于业务结合"></a>5. 让Netty更好的于业务结合</h4><ul>
<li><p>与Spring结合</p>
<p>由于业务上基本都是使用Spring框架，为了在Spring中使用Netty，需要将Netty的启动Server配置为一个Bean, 由Spring服务初始化。注意Netty启动会阻塞本身线程的问题。那么跟Netty相关的Pipeline子handler均要定义为bean，这样就可以使用原有的业务系统中的服务了。</p>
</li>
<li><p>按业务路由</p>
<p>考虑到以后会有其他业务使用Websocket的场景，那么我们必须将websocket的能力按照业务进行区分。本人的建议是从URL上来区分业务，不同的业务使用不同URL。去掉通用websocket的前缀后，根据后门的URL来区分业务。<br><code>ctx.channel().attr(WebSocketConstants.TOPIC).set(msg.getUri().substring(WebSocketConstants.wsUriPrefix.length()));</code></p>
<p>建议设置一个Websocket的ENUM TOPIC，不同的业务拥有不同的TOPIC，这样就可以根据URL来区分业务了。</p>
</li>
</ul>
<h4 id="6-后记"><a href="#6-后记" class="headerlink" title="6. 后记"></a>6. 后记</h4><p> 使用Netty处理websocket还是非常方便的，加上其本事强大的网络处理能力，使得上层应用无需关系底层实现。虽然和Node.js这样技术比起来还是比较笨重，但随着业务的发展，我相信Java的优势会渐渐体现出来。</p>
<p> 使用websocket本事不难，难得是在分布式环境下使用长链接技术。其中涉及到业务状态的保存与恢复、服务器间通信的问题、停机维护的问题、状态跟踪的问题等等，如果业务比较复杂，那么异常处理的情况都会非常复杂。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/websocket/">websocket</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/12/23/利用Tair实现全局并发锁/" title="利用Tair实现分布式并发锁" itemprop="url">利用Tair实现分布式并发锁</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2014-12-23T00:00:00.000Z" itemprop="datePublished"> Published 2014-12-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>最近大量使用到了Tair来控制并发，有点心得，总结如下。</p>
<ul>
<li><p>利用Tair实现全局并发锁</p>
<p> 现在基本上线上服务器都是集群环境，那么当我们需要对中心化数据（例如:Tair、数据库）的同一内容进行读写时就会碰到并发问题，这是一种非常常见的需求。解决并发问题的方法无非有两种，在并发点控制并发或者在并发源头控制。<br><img src="http://img3.tbcdn.cn/L1/461/1/48437662f3c9714c3dafff4c0a29fe84215571ba" alt="_"></p>
<p> 图画的有点丑。并发点控制最常用的一种方式就是使用锁，每个需要访问数据的线程都需要先获取锁，然后才能去访问数据库。根据获取锁的策略的不同，又可以根据不同纬度分为乐观锁、悲观锁，忙等、闲等，互斥锁、读写锁等等。</p>
<p> 在并发源头控制就是利用第三方的工具，一般是消息队列来将并发访问串行化，然后由统一的数据操作者来访问数据。消息队列的使用不在本文的讨论范文内。比较有名的开源消息队列有,<a href="http://www.rabbitmq.com/" target="_blank" rel="noopener">RabbitMQ</a>,<a href="http://zeromq.org/" target="_blank" rel="noopener">ZeroMQ</a>。当然,公司内部也有对应的产品，如<a href="http://baike.corp.taobao.com/index.php/Notify" target="_blank" rel="noopener">Notify</a>,<a href="http://gitlab.alibaba-inc.com/middleware/metaq3/wikis/what_is_metaq" target="_blank" rel="noopener">MetaQ</a>。</p>
<p>由于在分布式环境中，要实现全局的并发锁，那么我们必须借助第三方的服务来进行协调。数据库和缓存经常会成为我们的优先选择。出于性能的考虑，一般选用缓存来实现全局并发锁，其中的关键也就是借助Tair的<a href="http://baike.corp.taobao.com/index.php/Faq#.E4.BB.80.E4.B9.88.E6.98.AFversion.EF.BC.9F" target="_blank" rel="noopener">Version</a>控制，相比已经有很多人已经在这样做了。Tair提供了以下API：</p>
<p><code>ResultCode put(int namespace, Object key, Serializable value, int version, int expireTime)</code></p>
<p>利用该API实现并发控制轻而易举,伪代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    //加锁</span><br><span class="line">	public boolean lock(String key, int timeOut) &#123;</span><br><span class="line">         ResultCode rc = tairManager.put(NAMESPACE, key, DEFAULT_VALUE, INIT_VERSION, timeOut);</span><br><span class="line">         return rc!=null&amp;&amp;ResultCode.SUCCESS.equals(rc)?true:false;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     //解锁</span><br><span class="line">     public boolean unlock(String key) &#123;</span><br><span class="line">         ResultCode rc = tairManager.invalid(NAMESPACE, key);</span><br><span class="line">return rc!=null&amp;&amp;ResultCode.SUCCESS.equals(rc)?true:false;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>  这主要是利用了Tair的VERSION特性。如果KEY不存在的话，传入一个固定的初始化VERSION，Tair会在保存这个缓存的同时设置这个缓存的VERSION为你传入的<em>VERSION+1</em>；然而KEY如果已经存在，Tair会校验你传入的VERSION是否等于现在这个缓存的VERSION，如果相等则允许修改，否则将失败。  其过程如下图所示：</p>
<p><img src="http://img2.tbcdn.cn/L1/461/1/c8f6cdafb3401daf724c9e0649f69ce9de71b057" alt="global_lock"></p>
<p>   这是一个很通用的过程，但是却能涵盖大部分的场景。其实理解这个过程非常简单，这里可以把其想象成受精卵形成的过程。虽然有成千上万个精子会进入卵巢，但当第一个精子和卵子结合以后就会形成一层隔离层，以阻止其他精子的进入。而这里的隔离层就类似于TAIR的<a href="http://baike.corp.taobao.com/index.php/Faq#.E4.BB.80.E4.B9.88.E6.98.AFversion.EF.BC.9F" target="_blank" rel="noopener">VERSION</a>。如果想知道更多过程可以参考<a href="http://baike.corp.taobao.com/index.php/Faq#.E4.BB.80.E4.B9.88.E6.98.AFversion.EF.BC.9F" target="_blank" rel="noopener">VERSION</a>的文档。</p>
<ul>
<li><p>利用Tair实现全局TOP-N并发锁</p>
<p>全局TOP-N并发锁是我自己想出来的一个名字，有点不明觉厉吧。实际业务中我们可能会遇到这样一种情况，在短时间内会有大量的并发来获取某种资源，但是我们这个资源又有数量限制。例如，抢火车票，在某一时刻将1000张火车票发出去，假如有大量的用户在同一时间来抢这些火车票就会形成并发，同时我们又有着很高的性能要求。以抢火车票为例，下面是我的思考过程。</p>
<p>因为我需要控制并发，要告诉第1001个用户你没有抢到，那么我肯定需要一个计数器来保存火车票发售的实时情况，那么很容易就写出了以下伪代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if(get(ticker_counter)&lt;1000)) &#123;</span><br><span class="line">    bool lockFlag=lock(key,60);</span><br><span class="line">	if(lockFlag) &#123;</span><br><span class="line">		int counter=get(ticker_counter);</span><br><span class="line">		if(++counter&lt;1000) &#123;</span><br><span class="line">			set(ticker_counter=counter)</span><br><span class="line">		&#125;</span><br><span class="line">		unlock(key);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>  首先获取当前计数器的值，如果&gt;=1000则直接失败返回,表示已经被抢完了，但是如果&lt;1000，表示还没被抢完，则尝试去获取全局锁，如果获取成功则增加计数器的值，注意此时是需要再获取一次计数器的。但是这样会有一个明显的问题，就是当A获取了锁，正在执行增加计数器操作时，B也去尝试获取锁，此时必然是失败的。但是我现在就应该告诉他你已经失败了吗，你没有机会获得这张火车票了吗？显然不是。因为我们允许获取的资源是一个范围，那么当没有明确地表示现在资源已经超出这个返回了或者没有资源了，那么现在所有尝试得到资源的线程或者用户都是有机会的。此时，书中的一个概念浮现出来——信号量。这种业务场景正好是信号量技术能够解决的。但是在分布式环境下如何解决这个问题呢。</p>
<p>  我想到了Linux环境下编程时的很多技术。其中就有一个很这个业务场景非常相似的API，就是POSIX系列里面的<code>pthread_cond_wait()</code>和<code>pthread_cond_signal()</code>。前者会一直阻塞直到等待的资源变为可用，而后者会唤醒一个正在等待某个资源的线程。如果有有这两个语义的API存在的话就会变得非常简单，伪代码将变为：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if(get(ticker_counter)&lt;1000)) &#123;</span><br><span class="line">	    pthread_cond_wait();</span><br><span class="line">		int counter=get(ticker_counter);</span><br><span class="line">		if(++counter&lt;1000) &#123;</span><br><span class="line">			set(ticker_counter=counter)</span><br><span class="line">		&#125;</span><br><span class="line">		pthread_cond_signal();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>  只可惜在分布式环境下没有这两个语义的API操作存在，那么久不得不转化思维。之所以我需要这两个语义的API存在是因为我希望在A线程完成工作以后，将这个状态/消息通知到其他在等待的线程，并且这些线程是分布式的。其实这里是可以使用到消息模型的。notify会选择集群中的一台服务器投递消息，这就可以作为唤醒操作。所有的worker一开始都去监听notify的消息，直到其中一个worker收到，然后去checkAndInc(counter)，最后再发出一个消息，如此循环就能达到目的。最后只需要增加一个Trigger,在最开始执行的时候直接去执行，而不用等待notify消息，就能完成完整的流程。但是，如此简单地一个功能，真的要实现的这么复杂吗？当然不行，什么时候都要坚持KISS原则。</p>
<p>  其实，我最终的目的很简单，就是增加一个计数器的值，然后达到某一上线时希望能够得到一个错误返回。因为在做以前一个项目时使用到了Tair中计数器的功能，带着侥幸的心理重新去找Tair的API，居然发现了这个重要API:</p>
<pre><code>`Result&lt;Integer&gt; incr(int namespace, Serializable key, int value, int defaultValue, int expireTime, int lowBound, int upperBound)`
</code></pre><p>  当我看到这个API的时候感悟良多，在此还是要感谢一下设计这个API的作者，因为这个API的设计就是为这种业务场景而生的。这个<code>incr()</code>操作可以指定一个范围段，如果value值不在这个范围段中就会报错。有个这个API那么伪代码就简化成以下：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = tairManager.incr(NAMESPACE, key, 1, 0, 60, 0, 1000);</span><br><span class="line">    return ResultCode.SUCCESS.equals(result.getRc())? true : false</span><br></pre></td></tr></table></figure>
<p>   这个多么的简洁和优雅,而且又有着很高的性能。如果有着类似的业务场景，推荐大家不妨试一下这个API。</p>
<ul>
<li><p>一点思考</p>
<p>现在分布式计算越来越受到重视，随着去IOE的深入，大型机的时代一去不复返。但是分布式计算的流行使得程序员思考问题的方式也在发生改变，以前在单机上运行很好地系统，拿到分布式环境下可能就会出现各种问题。虽然整体架构发生了很大的变化，但是单机时代的很多思想还是值得我们去借鉴的。就比如信号量计算，PV操作。以前这些技术靠操作系统去实现就好了，但是在分布式环境下就很难实现这些以前看似很自然的功能。从某种程度上，这又为我们的中间件技术指明了发展的道路。如果哪一天业务程序员能在分布式环境中像在单机环境里编程，那分布式技术的发展就达到了一个新的高度。</p>
</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/distributed-lock/">distributed lock</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2011/10/03/C#网络编程初步之TCP/" title="C#网络编程初步之TCP" itemprop="url">C#网络编程初步之TCP</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2011-10-03T02:22:40.000Z" itemprop="datePublished"> Published 2011-10-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><strong>阅读背景：本文针对有C#的初学者而写的，主要讲解如何利用C#进行网络编程。<br>如果你已经有一些网络编程的经验（只需要懂得网络编程的基本常识即可），并且理解C#的基本语法，那么这篇文章可以很快地带你进入C#网络编程的世界。<br>如果你的基础不好，也不要紧，我相信这篇文章也会有你需要的内容。</strong></p>
<p>网络编程基础复习：</p>
<p>   <img src="http://hi.csdn.net/attachment/201110/2/0_1317580064Gkl4.gif" alt="TCP-Module"></p>
<p> 图1. TCP编程基本模型</p>
<p> 相信很多人看到图1应该不会陌生，这是一个利用TCP进行通信的经典模型图。我想大家都应该把这张图记在心中。<br> 在此我就不讲述上图中每个API的意思了，百度一下，你就知道。我想说的是，难道你不觉得这么编程很累吗?<br> 我们需要去调用每个API函数，然后每个判断返回值是多少，如果你忘记了哪个API的参数形式还得去查MSDN，这种时间花费是巨大的，尤其当你做应用层的快速开发时。</p>
<p> 图2是利用UDP通信时的编程基本模型，这个模型较为简单，但是应用极为广泛，相比TCP而言，我本人觉得利用UDP通信是一门更为高深的技术，因为它是无连接的，<br> 换言之，它的效率与灵活度就更高些。</p>
<p>   <img src="http://hi.csdn.net/attachment/201110/2/0_131757970540yA.gif" alt="UDP-Module"></p>
<p>图2. UDP编程基本模型</p>
<p>   在此我补充一点，关于何时利用TCP通信、何时利用UDP通信的问题。他们的特性其实已经决定了他们的适用范围。<br>   在进行大数据量、持续连接时，我们使用TCP，例如FTP协议；而在进行小规模数据、突发性高的通信时，我们使用UDP，例如聊天程序。<br>   但是，这并不是绝对的事情。例如流媒体通信，它是大数量、持续的通信，但是使用的是UDP协议，为什么呢？<br>   ——因为我们不关心丢失的帧，人的肉眼是无法识别出少量的帧丢失的。那么使用UDP通信就可以大幅度提高效率，降低网络负载。</p>
<h3 id="C-之TCP编程"><a href="#C-之TCP编程" class="headerlink" title="C#之TCP编程"></a>C#之TCP编程</h3><p><strong>如何创建一个套接字?</strong></p>
<p>我们先来看看利用Winsock2是如何建立一个套接字的：</p>
<p>首先，我们要加载套接字库，然后再建立套接字。大致代码如下：</p>
<pre><code>WORD wVersion=MAKEWORD(2,2);
WSADATA wsaData;
if(WSAStartup(wVersion,&amp;wsaData))
{
WSACleanup();
returnFALSE;
}

m_sock=WSASocket(AF_INET,SOCK_DGRAM,IPPROTO_UDP,NULL,0,0);
if(m_sock==INVALID_SOCKET)
{
        MessageBox(&quot;创建套接字失败！&quot;);
        return FALSE;
}
</code></pre><p>  难道你不觉得利用Winsock2创建一个套接字很费劲吗？如果你在Linux环境中变成倒是可以省掉加载套接字的部分，<br>  但是却只能反复的调用API，这样也是很费时的事情。那我们再看看看利用C#是如何帮你简化工作的。这里我会介绍TCPClient类。</p>
<p>  <img src="http://hi.csdn.net/attachment/201110/2/0_131758022652u1.gif" alt="msdn"></p>
<p>  以上是从MSDN上截取的一段话，可见我们利用TCPClient还处理与TCP通信相关的操作。TCPClient有四个构造函数，每个构造函数的用法是有不同的。这里我补充一个知识，那就是端地址在C#中描述。<br>  我们知道，我们用一个IP地址和一个端口号就可以表示一个端地址。在C#中我们利用IPEndPoint类来表示一个端地址，本人经常利用如下的构造函数来创建一个IPEndPoint类。</p>
<pre><code>IPEndPoint localEP = new IPEndPoint(IPAddress.Parse(&quot;127.0.0.1&quot;),6666);
</code></pre><p>这样来表示一个端地址是不是比创建一个struct sockaddr_in的结构体来的快呢？</p>
<p><strong>如何绑定一个端地址？</strong></p>
<p>  我们已经创建了一个端地址，也构造了套接字（TCPClient类），那么如何将二者绑定起来呢?也许你已经发现了，在建立TCPClient的时候我们其实就可以绑定端地址了。<br>  如果你使用的TCPClient tcp_Client=new TCPClient()的构造函数来创建的TCPClient,那么系统会认为你没有人为的制定端地址，而会自动帮你制定端地址，在创建客户端的TCPClient时我们常常这样做，<br>  因为我们不关心客户端的端地址。如果是服务器监听呢？在服务器监听时我们会使用例外一个类，叫做TCPListener，接下来我会讲到。我们可以利用TCPClient(IPEndPoint)来构造一个绑定到固定端地址的TCPClient类。例如：</p>
<pre><code>TcpClient tcp_Client = new TcpClient(localEP);
</code></pre><p><strong>如何监听套接字？</strong></p>
<p>   到现在为此我们还没讨论如何监听一个套接字。在传统的socket编程中，我们创建一个套接字，然后把它绑定到一个端地址，而后调用Listen()来监听套接字。而在C#中，我们利用TCPListener来帮我们完成这些工作。让我们先来看看如何在C#监听套接字。</p>
<pre><code>IPEndPointlocalEP = new IPEndPoint(IPAddress.Parse(&quot;127.0.0.1&quot;),6666);
TcpListenerListener = new TcpListener(localEP);
Listener.Start(10);
</code></pre><p>  我们首先创建需要绑定的端地址，而后创建监听类，并利用其构造函数将其绑定到端地址，然后调用Start(int number)方法来真正实施监听。这与我们传统的socket编程不同。以前我们都是先创建一个socket，然后再创建一个sockaddr_in的结构体。我想你应该开始感受到了C#的优势了，它帮我们省去了很多低级、繁琐的工作，让我们能够真正专注于我们的软件架构和设计思想。</p>
<p><strong>如何接受客户端连接？</strong></p>
<p>  接听套接字后面自然就是接受TCP连接了。我们利用下面一句话来完成此工作：</p>
<pre><code>TcpClient remoteClient =Listener.AcceptTcpClient();
</code></pre><p>  类似于accept函数来返回一个socket,利用TCPListener类的AcceptTcpClient方法我们可以得到一个与客户端建立了连接的TCPClient类，<br>  而由TCPClient类来处理以后与客户端的通信工作。我想你应该开始理解为什么会存在TCPClient和TCPListener两个类了。<br>  这两个类的存在有着更加明细的区分，让监听和后续的通信真正分开，让程序员也更加容易理解和使用了。</p>
<p>这里我还得补充一点：监听是一个非阻塞的操作<code>Listener.Start()</code>，而接受连接是一个阻塞操作<code>Listener.AcceptTcpClient</code>。</p>
<p>说了这么多，还不如来个实例来的明确。接下来，我会通过一个简单的控制台聊天程序来如何使用这些。先贴代码吧！</p>
<p>服务器端：</p>
<pre><code>using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Net;
using System.Net.Sockets;

namespace Demo
{
    class Program
    {
        static void Main(string[]args)
        {
            byte[]SendBuf = Encoding.UTF8.GetBytes(&quot;Hello,Client!&quot;);    //发给客户端的消息；
            IPEndPointlocalEP = new IPEndPoint(IPAddress.Parse(&quot;127.0.0.1&quot;),6666);        //本地端地址
            TcpListenerListener = new TcpListener(localEP);            //建立监听类，并绑定到指定的端地址
            Listener.Start(10);           //开始监听                                                            
            Console.WriteLine(&quot;Server is listening...&quot;);                           
            TcpClientremoteClient = Listener.AcceptTcpClient();  //等待连接（阻塞）
            Console.WriteLine(&quot;Client:{0} connected!&quot;,remoteClient.Client.RemoteEndPoint.ToString()) ;     //打印客户端连接信息；
            remoteClient.Client.Send(SendBuf);     //发送欢迎信息；
            remoteClient.Close();                  //关闭连接；
        }
    }
}
</code></pre><p>客户端:</p>
<pre><code>using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Net;
using System.Net.Sockets;

namespace Demo_Client
{
    class Program
    {
        static void Main(string[] args)
        {
            byte[] RecvBuf=new byte[1024];                    //申请接收缓存；
            int RecvBytes = 0;                                            //接收字节数；
            string recvmsg=null;                                      //接收消息；

            IPEndPoint remoteEP = new IPEndPoint(IPAddress.Parse(&quot;127.0.0.1&quot;), 6666);      //远程服务器端地址；
            TcpClient remoteServer = new TcpClient();                   //创建TCPClient类来与服务器通信；
            remoteServer.Connect(remoteEP);                                  //调用connect方法连接远端服务器；
            Console.WriteLine(&quot;I&apos;m using {0}.&quot;, remoteServer.Client.LocalEndPoint);          //打印自己使用的端地址；
            RecvBytes=remoteServer.Client.Receive(RecvBuf);                           //接受服务器发送过来的消息；
            recvmsg=Encoding.UTF8.GetString(RecvBuf,0,RecvBytes);          //将接受到的字节码转化为string类型；
            Console.WriteLine(&quot;Server says:{0}.&quot;, recvmsg);              //打印欢迎信息；
        }
    }
}
</code></pre><p>   在C#网络编程中，我们要用到两个名空间，分别是System.Net和System.Net.Socket。<br>   可能有人会有这样的疑惑，干嘛要申请一个Byte数组。我们知道，在传统socket编程中，我们都是用char<em>来发送或者接受消息的，<br>   其实char</em>和Byte[]是同源的。他们都是一个Byte，而使用Byte[]能更易于人们理解和转化为其他类型。我们知道网络间传输的字节流，而Byte[]刚好符合了这个思想。<br>   如果对以上类的用法不理解或者不熟悉的话，建议查看MSDN，上面讲解的很详细。</p>
<p>现在看看运行效果：</p>
<p><img src="http://hi.csdn.net/attachment/201110/2/0_1317579792B9CZ.gif" alt="result"></p>
<p>图3 运行效果（左为服务器，右为客户端）</p>
<p>  好啦，到这里我们C#网络编程初步之TCP基本上算告一段落了，我只讲解了最为基础的部分，仅做抛砖引玉的作用。每个类的使用千变万化，希望你能找到最适合自己使用方法。现在你可以对比以前类似程序的代码了，看看我前面有没有说错。而且，越到后来你会越来越体会到C#人性化的一面。</p>
<p>  后期的博文中，我会更新C#网络编程初步之UDP.本人更喜欢利用UDP来进行通信，至于为什么我已经说过了。以后，我会逐步写一些网络编程的高级内容，例如异步通信、多线程编程，并关注程序员经常遇到的一些棘手问题，比如TCP边界的确定等等。有机会，我也会同大家讨论网络编程中常用的软件设计思想与架构。</p>
<p>（本文图1、图2来自互联网，有部分信息来自MSDN。如需转载本文，请注明出处！谢谢）</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/C/">C#</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/C-tcp-udp-network/">C# tcp udp network</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2011/09/03/超小型局域网组建的方案/" title="超小型局域网组建的方案" itemprop="url">超小型局域网组建的方案</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2011-09-03T15:20:25.000Z" itemprop="datePublished"> Published 2011-09-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>生活中我们经常会遇到需要组建一个超小型局域网共享上网的问题，比如在学校组建一个小型局域网共享上网，或者组建一个家庭网络共享上网等，在此过程中会碰到很多小问题，<br>本人故撰此文，望能减少一些不必要的麻烦。</p>
<p>在学校上网，可以通过校园网，也可以通过电信宽带或者ADSL拨号上网（通过电话线上网）等。通过校园网上网，经济实惠，当然网速也是惊人的，尤其是喜欢玩游戏的同学就更悲剧了。<br>通过校园网上网没有什么灵活性和扩展性，故在此不讲了。就以通过电信上网为例来进行分析与组建。如果你们寝室或出租屋有宽带接入，那么恭喜你了，<br>你可以省下一个“猫”钱。4台PC以下共享上网的话，那必需购置一台4孔的交换机，一般在40~50元左右，然后购置网线若干，就是普通的直连线，一块钱一米的那种。(像我们学校水晶头都收钱，悲剧！)<br>至此，所需的硬件就准备好了。</p>
<p>  然后就是子网划分了，由于是超小型局域网，在这里可以使用C类IP私有地址，即192.168.A.B ,子网掩码为255.255.255.0，网关为192.168.A.1 。（网关最后一位可以改变，但一旦确定就不应更改。）<br>  注意：0=&lt;A&lt;=254，A一旦确定也不应更改，1=&lt;B&lt;=254随着不同的PC应不同，不应重复。显然，该子网划分可允许254台PC接入，完全满足超小型局域网组建的需要。<br>子网划分完之后就是将相应的IP地址填入本地网络适配器中，可参照下图。 </p>
<p>到此局域网以组建完毕，可以进行局域网的对战、文件交互等操作，如果想连上Internet,那就继续往下看吧！<br>DNS应填写你所在区的DNS服务器的IP地址，例如你在湘大，可以填写首选DNS：<code>208.67.222.222</code>，备用DNS：<code>202.67.220.220</code>.<br>填写完之后就单击确定。</p>
<p><strong>在此强调，除IP地址最后一位外，其余的在不同PC配置时均不要更改，切记！</strong></p>
<p>接下来就是一些必要软件的安装，既然是通过电信上网，那就要装星空极速。然后在填入电信给你的上网账号就可以上网了，当然此时还只有你一个人能上网。其实有条件的同学可以包电信的“我的一家”这种上网业务，它允许多台PC共用一个账号上网。湖南电信这边上网是绑定MAC地址的，理应只允许一个账号让一台PC机上网，其实这是很不合理的。废话少说，要想多台PC共享上网，可以让交换机拨号，当然你买的交换机要支持拨号这种功能，具体操作可以上网BAIDU一下。也可以选择共享上网软件，在此我推荐湘大学长自己做的一款软件，拼卡啦，这是我用过的最好用的共享上网软件，简单，方便，我也感到蛮自豪的。在湘大上网用这款软件完全没问题，不过在其他地方上不上的了我就不知道了。关于这款软件的使用方法可以参照<a href="http://www.xiaorsz.com/lan-internet-sharing-software-pinkala-download/" target="_blank" rel="noopener">http://www.xiaorsz.com/lan-internet-sharing-software-pinkala-download/</a>  。<br>在此说明一下，一台PC通过星空极速拨号上网后，然后在通过拼卡啦创建共享，其余的PC通过拼卡啦加入共享即可都上网了。网络上还有很多其他的共享上网软件，比如CCPROXY，不过需要一台PC充当服务器，像拼卡啦这样实现服务器切换这么方便的，我还没发现。<br>好啦，现在我们已经可以多机共享上网啦！</p>
<p>如果你是包年的用户，或者不计流量的那种，建议使用交换机、路由器、猫自动拨号上网，很方便，插上网线就能上！如果有流量限制，且共享上网的PC较多，<br>（比如我原来寝室的6台PC共用一个账号上网的那些耻人们，呵呵，开个玩笑！）建议用共享软件上网，虽然每次都要拨号，不过可以省流量！<br>如果你住在南苑，600块钱一年的那种难寝室，那就只用通过<a href="http://zh.wikipedia.org/wiki/ADSL" target="_blank" rel="noopener">ADSL</a>上网了，有得上就行！那你得乖乖的买个猫，二手的也行。把电话线连接分线器，分线器一端连接座机，一段连接猫。然后猫在连接交换机的普通以太网口，有的交换接有个WAN接口，不要连那个。然后PC在连接到交换机即可，其他配制方法同上。<br>因为是共享上网，电信本着能赚就赚的原则肯定是不允许的。你会发现优势网页打不开但是QQ却登的上，这是因为电信查封了你们的80（HTTP服务使用的）端口，这是一个知名端口，而QQ是用随机端口，它就没办法了。此时，让那台拨号的PC端口重连一下就又可以打开网页了，因为这是换了个公网IP。<br>好啦，写到这里也就结束了。我省略了很多细节，大家都可以<a href="http://www.baidu.com" target="_blank" rel="noopener">Baidu</a>的到，希望对想共享上网的同学有所帮助。</p>
<p>如果有其他的方案也可以留言，互相交流！</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/网络/">网络</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/network-engineering/">network engineering</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/3/"><span></span>Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Better-code/" title="Better code">Better code<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/C/" title="C#">C#<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/DDD/" title="DDD">DDD<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/debug/" title="debug">debug<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/云计算/" title="云计算">云计算<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/安全/" title="安全">安全<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/架构设计/" title="架构设计">架构设计<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/生活/" title="生活">生活<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/编程心智/" title="编程心智">编程心智<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/编程感悟/" title="编程感悟">编程感悟<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/网络/" title="网络">网络<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/翻译/" title="翻译">翻译<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/踩过的那些坑/" title="踩过的那些坑">踩过的那些坑<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/部署/" title="部署">部署<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/DDD/" title="DDD">DDD<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/cloud/" title="cloud">cloud<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/云计算/" title="云计算">云计算<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/debug/" title="debug">debug<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/架构设计/" title="架构设计">架构设计<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/架构/" title="架构">架构<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/领域事件/" title="领域事件">领域事件<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/event/" title="event">event<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/life/" title="life">life<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/访问控制/" title="访问控制">访问控制<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/DSL/" title="DSL">DSL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/系统架构/" title="系统架构">系统架构<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/代码架构/" title="代码架构">代码架构<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/编程心得/" title="编程心得">编程心得<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/计费/" title="计费">计费<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/CQRS/" title="CQRS">CQRS<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C-tcp-udp-network/" title="C# tcp udp network">C# tcp udp network<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/感悟/" title="感悟">感悟<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/btrace/" title="btrace">btrace<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2020 
		
		<a href="/about" target="_blank" title="Michael Jiang">Michael Jiang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
