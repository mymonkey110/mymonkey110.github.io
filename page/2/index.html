
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>Michael-J</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Michael Jiang">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="Michael-J">
<meta property="og:url" content="http://michael-j.net/page/2/index.html">
<meta property="og:site_name" content="Michael-J">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Michael-J">

    
    <link rel="alternative" href="/atom.xml" title="Michael-J" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Michael-J" title="Michael-J"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Michael-J">Michael-J</a></h1>
				<h2 class="blog-motto">一个修行路上的码农</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:michael-j.net">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/08/02/跨Region实践初探/" title="跨Region实践初探" itemprop="url">跨Region实践初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2017-08-02T11:27:13.000Z" itemprop="datePublished"> Published 2017-08-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>最近网易云上线华北REGION(cn-north-1)地区的服务，在此过程中我们做出了很多调整以适应跨REGION架构。</p>
        
        
        <p class="article-more-link">
          
            <a href="/2017/08/02/跨Region实践初探/#more">Read More</a>
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/架构设计/">架构设计</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/云计算/">云计算</a><a href="/tags/架构/">架构</a><a href="/tags/高可用/">高可用</a><a href="/tags/分布式/">分布式</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/06/21/记一次坑爹的Debug过程/" title="记一次坑爹的Debug过程" itemprop="url">记一次坑爹的Debug过程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2017-06-21T10:46:22.000Z" itemprop="datePublished"> Published 2017-06-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>昨天QA跟我反馈说系统有几个接口反应很慢，起初我不以为意，因为这几个接口就是简单的写入和删除，最多就是再更新一下缓存，能有多慢。我让QA看看是不是网络抖动，延迟的问题，再看看我们的<code>access_log</code>里面响应时间是多少。QA说网络比较稳定，<code>access_log</code>里面显示要好几秒，这就让我有些诧异了。其中有一个删除用户XXX数据的接口响应特别慢，我们在测试环境去复现的时候果然复现了这个问题。当前端直接点击删除的时候，接口过了8秒多才返回，这肯定不正常了，而且<code>access_log</code>也印证了这一现象。</p>
        
        
        <p class="article-more-link">
          
            <a href="/2017/06/21/记一次坑爹的Debug过程/#more">Read More</a>
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/debug/">debug</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/debug/">debug</a><a href="/tags/调试/">调试</a><a href="/tags/mysql/">mysql</a><a href="/tags/工具/">工具</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/06/03/架构师应该是一种角色，而不是一个职位/" title="架构师应该是一种角色，而不是一个职位" itemprop="url">架构师应该是一种角色，而不是一个职位</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2017-06-03T07:23:13.000Z" itemprop="datePublished"> Published 2017-06-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>昨天看到一篇关于“架构师”的文章，读后非常有感触。我个人比较认同作者的大部分观点，故决定将原文进行翻译，和国内的开发者一起分享。原文地址：<a href="https://dzone.com/articles/architect-should-be-a-role-not-a-position" target="_blank" rel="noopener">“Architect” Should Be a Role, Not a Position”</a>。</p>
        
        
        <p class="article-more-link">
          
            <a href="/2017/06/03/架构师应该是一种角色，而不是一个职位/#more">Read More</a>
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/翻译/">翻译</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/架构设计/">架构设计</a><a href="/tags/软件开发理论/">软件开发理论</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/06/01/访问控制：为你的云上业务再加一把锁/" title="访问控制：为你的云上业务再加一把锁" itemprop="url">访问控制：为你的云上业务再加一把锁</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2017-06-01T10:56:02.000Z" itemprop="datePublished"> Published 2017-06-01</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>企业上云首当其冲的就是要解决安全性的问题，是否满足企业对安全的诉求成了影响其是否上云的一个十分重要的因素之一。安全是一个很大的话题，从底层资源数据的安全到上层应用访问的安全，从访问客体（资源或服务）的安全到访问主体（人或者第三方服务）的安全，这些都属于安全的范畴之内。访问控制正是从资源访问的主客体关系出发，解决企业对资源访问的权限控制的需求。</p>
<p>维基百科对<strong><em>访问控制</em></strong>的定义如下：</p>
<blockquote>
<p>访问控制是指允许或禁止某人使用某项资源的能力。</p>
</blockquote>
<p>云环境下的访问控制使得这个问题变得复杂，我曾写过一篇<a href="http://michael-j.net/2017/03/07/%E5%AF%B9%E4%BA%91%E7%8E%AF%E5%A2%83%E4%B8%8B%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%80%9D%E8%80%83/">对云环境下访问控制系统的思考</a>来阐述这个问题。从2.14号上线访问控制以来，接入访问控制的业务越来越多，截止目前已有六大业务支持访问控制；同时，访问控制还对云服务提供了支持，用户可以授权给易盾和视频云来访问其在NOS（网易对象存储）的数据资源。现在，你可以自定义访问控制策略，通过一套特定DSL语法来定义权限。根据自己的实际使用场景和组织架构来定义对权限的需求，这具有十分重要的意义。</p>
<p>举个例子，如果不允许某某子账号删除<code>avatar</code>桶中<code>file-1.png</code>的图片，而允许其对其他任何文件有所有的控制权限，那么可以定义如下的策略来达到这个目的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: 1,</span><br><span class="line">    &quot;statement&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;action&quot;: [</span><br><span class="line">                &quot;comb:nos:DeleteObject&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;effect&quot;: &quot;deny&quot;,</span><br><span class="line">            &quot;resource&quot;: [</span><br><span class="line">                &quot;comb:nos:*:*:*:avatar/file-1.png&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;action&quot;: [</span><br><span class="line">                &quot;comb:nos:*&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;effect&quot;: &quot;allow&quot;,</span><br><span class="line">            &quot;resource&quot;: [</span><br><span class="line">                &quot;comb:nos:*:*:*:*&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过语言来定义权限，用户将获得十分灵活的权限控制，当然也包含了细粒度的权限控制。使用DSL来定义权限的做法很早之前就存在了，可以追溯到2001年的<a href="https://en.wikipedia.org/wiki/XACML" target="_blank" rel="noopener">XACML</a>时代。目前主流的云计算厂商也均采用这种方式来描述权限。我们采用了业界相同的命名方式来降低用户的理解成本。这里对策略语法做一个简单的介绍。</p>
<p>策略语法就是有着一定约束关系的JSON格式数据，由<code>version</code>和<code>statement</code>两个部分组成。<code>version</code>目前只支持1，而<code>statement</code>则是描述策略的具体形式。<code>statement</code>由三个部分组成，<code>action</code>、<code>effect</code>和<code>resource</code>，这三个子句构成了访问控制最为核心的三个部分。</p>
<ul>
<li><code>effect</code>表示授权类型，只能是<code>allow</code>（允许）或者<code>deny</code>（拒绝）。</li>
<li><p><code>action</code>表示动作，组成结构为<code>product:service-name:action-name</code>。<code>product</code>目前只支持<code>comb</code>，<code>service-name</code>代表基础服务（蜂巢）下的服务，目前已支持的服务如下：</p>
<p>服务代号 | 服务名称<br>— | —<br>nos | 对象存储<br>nlb | 负载均衡<br>rds | 关系型数据库<br>mongodb | MongoDB<br>ncr | Redis缓存<br>cdn | CDN</p>
<p><code>action-name</code>表示具体动作的名称，例如nos支持<code>GetBucket</code>、<code>PutObject</code>等动作，cdn支持<code>CreateDomain</code>、<code>DisableDomain</code>等等，具体的动作请参考对应服务的文档。</p>
</li>
<li><p><code>resource</code>表示资源，组成结构为<code>product:service-name:region:az:account-id:resource-descriptor</code>。<code>product</code>和<code>service-name</code>和<code>action</code>中的意义相同，<code>region</code>表示地域，<code>az</code>表示可用域，目前只支持<code>*</code>，<code>account-id</code>是用户的主账号id，目前也只能填入<code>*</code>，<code>resource-descriptor</code>是具体资源的描述符。<code>resource-descriptor</code>根据具体的服务会有变化，整体上是树形结构的。例如：<code>bucket-1/file-1.png</code>可以表示nos中<code>bucket-1</code>的桶中的<code>file-1.png</code>文件，而<code>instance/nlb-1</code>可以表示nlb中实例名称为<code>nlb-1</code>的实例。具体的规则请参考对应服务的文档。</p>
</li>
</ul>
<p><code>statement</code>语句本身是一个Array，你可以在其中最多定义5条子句。这样就允许你将多条策略组合在一个策略里面，也可以根据需要将策略拆改，选择权在你手上。</p>
<p>通过上面的策略语言，企业完全可以根据自身的实际需要来定义权限，具有非常大的灵活性和自由度。如果你以前使用过其他云的访问控制产品，那么上手会很快。如果是第一次接触此类产品，也不用担心，我们提供了一个强大了“编译器”来检查你的策略语法是否合法，并提供简单直观的错误展示来帮你迅速定位问题，如下图所示。</p>
<img src="/2017/06/01/访问控制：为你的云上业务再加一把锁/compile_error.png" title="错误提示">
<p>另外，访问控制还提供了了<code>子账号</code>、<code>组</code>和<code>角色</code>来满足企业对访问主体描述性的需求，企业可以根据自身的组织架构和研发模式来组合使用这些身份。</p>
<p>掌握了授权策略后，理解鉴权的执行流程也是很重要的。鉴权流程按照Deny优先原则执行，如果有显式的Deny，那么直接拒绝；如果有显式的allow，那么则允许，否则也拒绝。具体流程如下。</p>
<img src="/2017/06/01/访问控制：为你的云上业务再加一把锁/auth_flow.png" title="鉴权流程">
<p>在授权时请遵循最小权限原则，即根据用户的需要，将刚好能满足其需求的权限赋予给他，这样有助于规避一些越权执行的问题。除此之外，最佳实践还包含及时收回用户不再需要的权限，尽量通过组和角色来授权等等。详细的文档可以参考访问控制的官方文档。</p>
<p>通过以上的介绍，不知道你是否对访问控制有一个大致的了解。如果还是有些云里雾里，那不如自己去动手定义一个属于自己的访问策略吧！</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/云计算/">云计算</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/cloud/">cloud</a><a href="/tags/访问控制/">访问控制</a><a href="/tags/DSL/">DSL</a><a href="/tags/云计算/">云计算</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/05/21/评论从多说迁移到Disqus/" title="评论从多说迁移到Disqus" itemprop="url">评论从多说迁移到Disqus</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2017-05-21T14:25:25.000Z" itemprop="datePublished"> Published 2017-05-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>建站以来一直使用多说作为评论系统，我还是非常喜欢国人做的评论系统，简单实用接地气。但是不盈利的商业软件最终只能关闭，这方面国内对盈利模式得探索要不国外落后太多了。</p>
<p>虽然切换到Disqus以后免不了被墙，但目前我确实还没有找到称心如意的评论软件。如果网友们有好的评论系统，不放留言给我推荐，叩谢！</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/生活/">生活</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/blog/">blog</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/03/07/对云环境下访问控制系统的思考/" title="对云环境下访问控制系统的思考" itemprop="url">对云环境下访问控制系统的思考</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2017-03-07T12:16:56.000Z" itemprop="datePublished"> Published 2017-03-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>现在，云计算市场已是一片红海，不论是国内还是国外的云计算市场竞争都相当激烈。主流的云计算厂商在争夺企业客户方面都不留余地，因为企业用户对云计算的发展有着极为重要的意义，尤其是大企业客户。可以毫不夸张的说，没有企业用户，云计算的发展绝不会发展的如此迅速。</p>
<p>企业上云首当其冲的问题就是安全性，安全性已经成为企业上云最大的障碍。这里的安全性不光是基础设施的安全和稳定，比如虚拟机的高可用、RDS的高可靠等等，也包括应用层面的安全性，如WAF、证书服务、加密服务等等，还包括因为企业本身的IT架构/研发架构的复杂性带来的资源管控方面的安全性需求。毫不夸张地说，谁解决好了企业的安全性诉求，那么他就能在这片红海中立于不败之地。</p>
<p>安全是一个很大的话题，我不敢妄谈。最近我在做访问控制方面的工作，故此分享一下我对这个领域的一点思考。访问控制是安全中一块，也是十分重要的一块。有些云计算提供商甚至都没有将其划归到安全的范围，可能是没有意识到访问控制的重要性。AWS中访问控制的产品是<a href="https://aws.amazon.com/cn/iam/" target="_blank" rel="noopener">IAM</a>，可以说是云计算厂商中做的最早也最为完善的一个。IAM在其的产品分类中有一个词我觉得形容该产品最为合适——“合规性“。其实访问控制就是满足企业用户对于合规性的需求，说白了就是规范企业用户对云计算资源的访问。</p>
<p>既然这是一篇关于访问控制的文章，那么我们先来看看关于访问控制的定义。</p>
<p>维基百科关于<strong><em>访问控制</em></strong>的定义是：访问控制是指允许或者禁止某人使用某项资源的能力。这个定义中有几个关键点需要留意：</p>
<ol>
<li>人</li>
<li>某项资源</li>
<li>允许/禁止</li>
<li>能力</li>
</ol>
<p>虽说维基百科关于访问控制的定义略显简陋，但是这个定义我觉得已经勾勒出了访问控制系统的大致形态。首先是人，访问控制的主体是人，所以其最为重要的使用群体是用户，那就是说这个系统是一个面向用户的系统。其次是某项资源，资源是访问控制的客体，某项的限定词则表明资源的具体形式是未知的。再次是允许/禁止，这是访问控制对外提供服务的最为直观的表现形式，用一个更为专业的名称来形容的话就是“鉴权”。最后是能力，为什么我把能力专门拿出来作为一个关键点来说，因为这是理论和实践的一个关键区分点之一。访问控制的理论为我们设计对应的系统和产品指明了方向，但是在生产环境中使用的还是遇到各种各样的现实问题。有一点需要特别注意的是，访问控制系统作为一个通用的公共服务，它需要提供的是一种能力，而不是针对特定环境和产品，否则只为沦为某个特定的专家系统。</p>
<p>维基百科关于【访问控制】的定义在理论层面已经颇为全面，然而从系统的设计到角度来看还缺少一个关键点，那就是——动作。这里的动作（可以也称之为操作）可以理解为具体系统所开放的能力，或者用户可以对系统执行的操作。例如，RDS产品需要开放<code>createDataBase\listDataBase\deleteDatabase</code>等等动作，又如NOS（网易对象存储）需要开放<code>listBucket\createBucket\listObject\putObject</code>等等动作。就算脱离云计算的环境，动作也是访问控制中不可缺少的要素之一，因为任何给人使用的产品都会伴随与人的交互，而这些交互的细粒度表现就是这些动作。</p>
<p>既然现在我们已经了解了访问控制的基本理论，那是否可以开始设计系统开始编码了呢？千万不要这么做，想清楚再做远比边做边想要节约时间。这听上去有点和现在的“敏捷开发“不太符合，实际上恰恰相反，”敏捷开发”虽然强调持续集成、快速迭代，但是这却是建立在前期良好的架构设计的基础之上的。言归正传，这是一篇关于访问控制实践探究的文章，在我们设计系统之前，先看看以前的访问控制系统一般是怎么做的。</p>
<h2 id="传统的访问控制模型"><a href="#传统的访问控制模型" class="headerlink" title="传统的访问控制模型"></a>传统的访问控制模型</h2><p>在访问控制系统的设计中，有两种设计模式是十分重要，也是得到广泛应用的，那就是访问控制列表（ACL）和基于角色的访问控制（RBAC）。</p>
<h4 id="1-访问控制列表（ACL）"><a href="#1-访问控制列表（ACL）" class="headerlink" title="1.访问控制列表（ACL）"></a>1.访问控制列表（ACL）</h4><p>访问控制列表是早期的一种访问控制技术，其原理十分简单，就是记录哪些用户对这个资源能进行哪些操作，有类似如下的二维表维护在文件中：</p>
<table>
<thead>
<tr>
<th>User</th>
<th>Create</th>
<th>Update</th>
<th>Query</th>
<th>Delete</th>
</tr>
</thead>
<tbody>
<tr>
<td>张三</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>×</td>
</tr>
<tr>
<td>李四</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>王五</td>
<td>×</td>
<td>×</td>
<td>√</td>
<td>×</td>
</tr>
</tbody>
</table>
<p>这种访问控制的方式好处显而易见，就是简单直观，易维护。这种设计在操作系统、路由器、交换机和工业控制系统中都得到了广泛的使用。不过，ACL的缺点也是显而易见的，那就是当用户、资源和操作组建增长时，维护这张表的代价会异常庞大，另外，这种设计模式将用户对资源的控制权限直接绑定，十分死板，灵活性不够，无法满足云环境下动态资源授权的需求。</p>
<h4 id="2-基于角色的访问控制（RBAC）"><a href="#2-基于角色的访问控制（RBAC）" class="headerlink" title="2.基于角色的访问控制（RBAC）"></a>2.基于角色的访问控制（RBAC）</h4><p>基于角色的访问控制将用户按其属性进行分类构建出一个个具体的角色，而将权限授权角色，用户通过扮演角色来间接地获取对应的权限。RBAC非常适合现实环境，尤其是企业，因为使用资源的使用者一般并不是资源的拥有者，资源的所有者属于企业。在云环境中更是如此，可能使用RDS的人是公司的开发或者PE，而RDS的归属者是对应的企业。RBAC从访问控制的主体的角度出发，很好使适应了企业的组织结构，同时也将用户和权限分离开了，用户只需要通过扮演不通的角色就能获得对应的权限，这种方式解决了云环境下动态授权的权限需求。</p>
<p>那是否RBAC能解决我们所有的问题了？显然不是。现实的问题往往是复杂的，不会像非黑即白这样简单。RBAC将人和权限分离的方法确实解决了一部分灵活性的问题，但是也增加了使用成本，同时它对细粒度的权限控制没有很好的应对之法。</p>
<h2 id="云环境下面临的挑战"><a href="#云环境下面临的挑战" class="headerlink" title="云环境下面临的挑战"></a>云环境下面临的挑战</h2><p>现在我们也知道了主流的访问控制模型一般是怎么做的了，那么如何应用在云环境中呢？我觉得在云环境下的访问控制系统主要面临以下几个挑战：</p>
<h4 id="1-资源标识的灵活性"><a href="#1-资源标识的灵活性" class="headerlink" title="1.资源标识的灵活性"></a>1.资源标识的灵活性</h4><p>访问控制的系统的立项一般都晚于云计算中的其他产品，因为它本身属于支撑产品。但随着其他产品形态组建完善，如何很好地描述各个产品的资源就成了一件非常令人头疼地问题。在一些IaaS的产品形态中，很大一部分是以实例(instance)的方式来提供服务的；而在某些PaaS的产品形态中，有些是实例的方式来提供服务，而又有一些有着很强的特殊性，比如上文提到的NOS，它们的资源描述是需要以树形方式来表达的。SaaS产品用统一的访问控制系统来管理一般不太可能，因为每个Software的产品形态和使用方式千差万别，你很难去做到统一。在对访问控制系统的设计过程中我发现了一个很有趣的现象，当你考虑的产品越接近应用层面（上层服务），访问控制系统就越接近专家系统。这样很好理解，越上层的服务它的特殊性越强，所以通用性越差，只能做成专家系统。</p>
<h4 id="2-细粒度的权限控制"><a href="#2-细粒度的权限控制" class="headerlink" title="2.细粒度的权限控制"></a>2.细粒度的权限控制</h4><p>访问控制系统的有一个比较困难的点，那就是细粒度的权限控制。这一点在访问控制模型中你找不到答案，它们只是在比较宏观的层面讨论了人和权限的关系。细粒度的权限控制是现实中存在的一个需求，比如一个企业有若干台虚拟机，有一些虚拟机用作webserver，而有一些虚拟机用作数据库，还有一些作为中间件服务器，比如Zookeeper等等。而使用这些虚拟机的人各不相同，他们能看到并操作的虚拟机也应该得到严格地监管，否则可能会引起安全事故。细粒度地权限控制关键点在于“多细”，越细致地控制会导致你的系统复杂度成倍增加，不利于的系统地可维护性。我的建议是只做到实例级别，但有一个例外，那就是对象存储。能做到多细的程度很大一部分取决于第一点中你地资源标识地方式，如果你的资源描述方式得当，那么更加细粒度地访问控制并不会增加你系统地复杂度。这个我会在下文中提到。</p>
<h4 id="3-身份的多样性"><a href="#3-身份的多样性" class="headerlink" title="3.身份的多样性"></a>3.身份的多样性</h4><p>如果一个云计算厂商想吃下一个大客户，满足其业务架构只是其一，还有一个十分重要的条件就是满足其组织架构。大企业绝对有实力也有能力解决其本身的业务架构，其实上不上云更多地是战略性的考虑，他们更加看重云服务的稳定性、安全性和可维护性。同时，其本身的组织架构也十分复杂，要想让其没有阻力地上云，解决其员工的身份问题首当其冲。所以现在主流的云厂商都会提供多种身份的表示方式，例如：子账号、组和角色。</p>
<h4 id="4-权限的描述方式"><a href="#4-权限的描述方式" class="headerlink" title="4.权限的描述方式"></a>4.权限的描述方式</h4><p>权限的描述方式也是十分重要的一个点，可以说这个点设计得好坏决定了你后期能否悠然地应对业务方的接入还是每天火急火燎地和各个业务方定协议定接口。我们知道所有需要访问控制的云产品必然有其支持的动作（Action），每个产品资源(Resource)的描述方式也各不相同，同时允许（Allow）还是禁止(Deny)针对某个资源的操作也是需要明确给出来的。这三个点构成了权限描述的三个要素。如果在前期的设计中没有充分思考这个问题，那么恭喜你，你很有可能给自己埋了一个深坑。你很有可能设计几张大表，来表示各个业务方支持的动作，资源以及用户和他们的关系。出现这样的设计是因为没有真正理解访问控制系统的业务领域。当你在设计这几张表的时候其实意味着访问控制系统在“理解”各个产品的功能，这对一个通用的访问控制系统是致命的。访问控制系统作为一个底层/共享的通用系统，对外输出地只能是能力，而不是去理解各个产品它们自己地业务领域。说到这里，我还是推荐所有的技术人员都有必要学习一下DDD的理论，就算不用自己写代码，系统性地学习其战略模式也会让你收益颇多。</p>
<h4 id="5-动态的授权体系"><a href="#5-动态的授权体系" class="headerlink" title="5.动态的授权体系"></a>5.动态的授权体系</h4><p>这一点相比以上4点来说要简单，这是因为如果你的访问控制系统已经很好地解决上面的挑战，那么你也就自然而然得获得了动态的授权体系。之说以是动态的，是因为云环境下用户和权限的关系往往不是一成不变的。用户在某个时刻希望获得A授权，而在另外一个时刻又希望获得B授权，而且有时授权还带有时效性，当过了截至时间授权也就自动失效了。这种动态性的需求是真实存在的，但我认为满足这个需求依赖于针对前4点的设计，如果把前面的设计做好了，那么系统也就自然而然地满足了动态性的需求，这是一个水到渠成的过程。</p>
<h2 id="业界是如何处理这个问题"><a href="#业界是如何处理这个问题" class="headerlink" title="业界是如何处理这个问题"></a>业界是如何处理这个问题</h2><p>说实话，当我去设计蜂巢的访问控制系统的时候并没有像现在考虑的这么全面。我意识到了一些问题的棘手性，也调研了现在业界做访问控制的方法，可以说做的最好的还是<a href="https://aws.amazon.com/cn/iam/" target="_blank" rel="noopener">IAM</a>。<br><a href="https://aws.amazon.com/cn/iam/" target="_blank" rel="noopener">IAM</a>将用户身份划归为子用户、组和角色，基本上这三种身份标识可以满足身份多样性的要求了。我觉得<a href="https://aws.amazon.com/cn/iam/" target="_blank" rel="noopener">IAM</a>关于权限描述的方式令我耳目一新，它使用了领域专用（DSL）语言来描述权限，具体的形式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line">  &quot;Statement&quot;: &#123;</span><br><span class="line">    &quot;Effect&quot;: &quot;Allow&quot;,</span><br><span class="line">    &quot;Action&quot;: &quot;s3:ListBucket&quot;,</span><br><span class="line">    &quot;Resource&quot;: &quot;arn:aws:s3:::example_bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是我第一次接触<a href="https://en.wikipedia.org/wiki/Domain-specific_language" target="_blank" rel="noopener">DSL</a>的概念，当时对这种设计模式是完全懵逼的，也不太理解其设计思想。随着考虑的问题越来越多，我发现了<a href="https://en.wikipedia.org/wiki/Domain-specific_language" target="_blank" rel="noopener">DSL</a>的强大之处。因为云环境下的访问控制系统最令人头疼的问题就是资源和权限的描述方式，这种极致的灵活性很难通过设计表格来获得。因为任何的以表为中心的设计方式都会映射到某个具体的领域模型上，又因为各个业务的权限控制各不相同，难道说我要根据各个业务来建立模型？前面也说过了，这是万万不可取的，这样设计只会让你深陷无尽的加班和调试之中。用<a href="https://en.wikipedia.org/wiki/Domain-specific_language" target="_blank" rel="noopener">DSL</a>来将访问控制和具体的权限理解分隔开了是最为合适的方式。</p>
<p>通过一套约定的DSL语法来描述权限，访问控制系统可以获得极大的灵活性，同时也不需要理解具体的权限。对权限的理解还是由各个业务方自己控制，这样系统就获得了最大程度的解耦。访问控制系统只用维护这套DSL语法就可以无限的扩展性，多么完美的方案啊！有时间我会专门写一篇关于DSL的文章来对其应用场景进行分析。</p>
<p>实际上，用DSL语法来描述权限也不是<a href="https://aws.amazon.com/cn/iam/" target="_blank" rel="noopener">IAM</a>首创，早在2001年就出现了响应的规范——<a href="https://en.wikipedia.org/wiki/XACML" target="_blank" rel="noopener">XACML</a>（可扩展的访问控制高标识语言），该规范现在已经发展到3.0了。其大致的鉴权流程如下图所示，如果对其原理由兴趣的同学可以查看对应的资料。</p>
<img src="/2017/03/07/对云环境下访问控制系统的思考/XACML.png" title="This image shows the XACML architecture and a sample authorization flow.">
<p>以上就是我对云环境下访问控制系统的一点理解，如有不严谨的地方，还望指正。总而言之，云环境下的访问控制系统面临的挑战很多，充分理解访问控制的原理有助于理解代码背后的意义，让我们的系统设计不至于走偏。基于<a href="https://en.wikipedia.org/wiki/Domain-specific_language" target="_blank" rel="noopener">DSL</a>的访问控制模型已经成为业界的主流，但各个云计算厂商自身的业务场景和面向目标人群又各有不通，如何制定适应自身环境的DSL成为了一个关键。后续有机会我会分享网易蜂巢在访问控制系统方面的实践。</p>
<h4 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h4><p><a href="http://www.cec-ceda.org.cn/information/book/info_6.htm" target="_blank" rel="noopener">访问控制</a><br><a href="http://blog.csdn.net/bluishglc/article/details/6577778" target="_blank" rel="noopener">访问控制模型ACL和RBAC</a><br><a href="https://martinfowler.com/books/dsl.html" target="_blank" rel="noopener">DSL</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/云计算/">云计算</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/cloud/">cloud</a><a href="/tags/访问控制/">访问控制</a><a href="/tags/架构设计/">架构设计</a><a href="/tags/DSL/">DSL</a><a href="/tags/云计算/">云计算</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/21/Spring-Boot反序列对象失败/" title="Spring Boot反序列对象失败" itemprop="url">Spring Boot反序列对象失败</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2016-12-21T02:21:55.000Z" itemprop="datePublished"> Published 2016-12-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>现在Spring Boot这个项目很火，尤其是微服务的流行，Spring Boot作为Java语言最热门的微服务框架之一，它极大地简化了Spring的配置过程。只需要一个注解就可以把整个工程拉起来，大大地降低了Spring的学习成本。我记得Spring Boot的某个开发人员说过，Spring Boot最令开发者激动的功能是可以自定义banner，哈哈，我也非常喜欢这个功能。</p>
<p>言归正传，开始介绍今天我遇到的一个诡异的问题。我使用Redis来缓存一些数据，但是这些数据在反序列的时候报错了。由于原工程涉及一些敏感信息，我新建了一个demo工程来说明这个问题。报错信息如下：</p>
<blockquote>
<p>java.lang.ClassCastException: com.netease.boot.dal.Product cannot be cast to com.netease.boot.dal.Product</p>
</blockquote>
<p>看到这个报错我就懵逼了，以致于我对了好几遍来确认眼睛没有看花。经过若干次重试，还是一样的错误。有人可能会对<code>Product</code>的实现产生怀疑，是不是没有加<code>serialVersionUID</code>，作为一个专业老司机，这点错误我还是不会犯得。我贴一下相关的代码：</p>
<p>Product类如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">public class Product implements Serializable &#123;</span><br><span class="line">    private static final long serialVersionUID = -5837342740172526607L;</span><br><span class="line"></span><br><span class="line">    @Size(min = 1, max = 32)</span><br><span class="line">    private String code;</span><br><span class="line">    @Size(min = 1, max = 16)</span><br><span class="line">    private String name;</span><br><span class="line">    @Size(max = 255)</span><br><span class="line">    private String description;</span><br><span class="line">    @NotNull</span><br><span class="line">    private EMailAddress principalEmail;</span><br><span class="line"></span><br><span class="line">    public Product(String code, String name, String description, EMailAddress principalEmail) &#123;</span><br><span class="line">        this.code = code;</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.description = description;</span><br><span class="line">        this.principalEmail = principalEmail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void changeName(String newName) &#123;</span><br><span class="line">        this.name = newName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void changeDescription(String newDescription) &#123;</span><br><span class="line">        this.description = newDescription;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void changePrincipalEMail(EMailAddress newPrincipalEMail) &#123;</span><br><span class="line">        this.principalEmail = newPrincipalEMail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getCode() &#123;</span><br><span class="line">        return code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getDescription() &#123;</span><br><span class="line">        return description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public EMailAddress getPrincipalEmail() &#123;</span><br><span class="line">        return principalEmail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;Product&#123;&quot; +</span><br><span class="line">                &quot;bizCode=&apos;&quot; + code + &apos;\&apos;&apos; +</span><br><span class="line">                &quot;, name=&apos;&quot; + name + &apos;\&apos;&apos; +</span><br><span class="line">                &quot;, description=&apos;&quot; + description + &apos;\&apos;&apos; +</span><br><span class="line">                &quot;, principalEmail=&quot; + principalEmail +</span><br><span class="line">                &apos;&#125;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>redis service相关的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">　　@Override</span><br><span class="line">public void put(String key, Serializable content) throws RedisException &#123;</span><br><span class="line">    Jedis jedis = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        jedis = redisPoolConfig.getJedis();</span><br><span class="line">        byte[] contentBytes = SerializationUtils.serialize(content);</span><br><span class="line">        jedis.set(key.getBytes(ENCODING), contentBytes);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        LOG.error(&quot;Put error:&#123;&#125;.&quot;, e.getMessage(), e);</span><br><span class="line">        throw new RedisException(e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (jedis != null) &#123;</span><br><span class="line">            redisPoolConfig.releaseJedis(jedis);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">　　@Override</span><br><span class="line">public &lt;T&gt; T get(String key) throws RedisException &#123;</span><br><span class="line">    Jedis jedis = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        jedis = redisPoolConfig.getJedis();</span><br><span class="line">        byte[] valueBytes = jedis.get(key.getBytes(ENCODING));</span><br><span class="line">        if (valueBytes == null || valueBytes.length == 0) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        return SerializationUtils.deserialize(valueBytes);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        LOG.error(&quot;Get error:&#123;&#125;.&quot;, e.getMessage(), e);</span><br><span class="line">        throw new RedisException(e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (jedis != null) &#123;</span><br><span class="line">            redisPoolConfig.releaseJedis(jedis);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实在没办法，这尼玛是什么问题。因为我以前这么使用过，而且工作的非常好，为毛这次就不行了。没办法了，加debug代码，我让get方法返回Object，再外面强转，（冥冥中有一种感觉，像是泛型的问题）。修改后的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public Object get(String key) throws RedisException &#123;</span><br><span class="line">        Jedis jedis = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            jedis = redisPoolConfig.getJedis();</span><br><span class="line">            byte[] valueBytes = jedis.get(key.getBytes(ENCODING));</span><br><span class="line">            if (valueBytes == null || valueBytes.length == 0) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">            Object o = SerializationUtils.deserialize(valueBytes);</span><br><span class="line">            return o;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            LOG.error(&quot;Get error:&#123;&#125;.&quot;, e.getMessage(), e);</span><br><span class="line">            throw new RedisException(e);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (jedis != null) &#123;</span><br><span class="line">                redisPoolConfig.releaseJedis(jedis);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在反序列化之后加断电debug，观察变量o，得到如下所示的图：<br><img src="http://7xnwpq.com1.z0.glb.clouddn.com/redis-deser.png" alt="redis-get"></p>
<p>WTF! IDE都识别出来了变量o是Product类型，但是后续的强转还是失败。经过我的测试发现所有的通过redis反序列化出来的类都有这个问题。万般无奈之下，我陷入了深深地沉思之中…之中…中…</p>
<p>我开始怀疑是序列化的姿势不对，但是为毛以前可以啊。不管了，先加一段测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Product product = <span class="keyword">new</span> Product(<span class="string">"comb"</span>,<span class="string">"蜂巢"</span>,<span class="string">"云计算基础设施产品"</span>,<span class="keyword">new</span> EMailAddress(<span class="string">"hzxx@corp.netease.com"</span>));</span><br><span class="line">        <span class="comment">/*FileOutputStream fileOutputStream = new FileOutputStream("/home/mj/work/product.data");</span></span><br><span class="line"><span class="comment">        fileOutputStream.write(SerializationUtils.serialize(policyContext));</span></span><br><span class="line"><span class="comment">        fileOutputStream.flush();</span></span><br><span class="line"><span class="comment">        fileOutputStream.close();*/</span></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"/home/mj/work/product.data"</span>));</span><br><span class="line">        oos.writeObject(product);</span><br><span class="line">        oos.flush();</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*FileInputStream fileInputStream=new FileInputStream("/home/mj/work/product.data");</span></span><br><span class="line"><span class="comment">        byte[] rawPolicyContext=new byte[fileInputStream.available()];</span></span><br><span class="line"><span class="comment">        fileInputStream.read(rawPolicyContext);</span></span><br><span class="line"><span class="comment">        PolicyContext pc = SerializationUtils.deserialize(rawPolicyContext);</span></span><br><span class="line"><span class="comment">        System.out.println(pc);*/</span></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"/home/mj/work/product.data"</span>));</span><br><span class="line">        Product pc = (Product) ois.readObject();</span><br><span class="line">        System.out.println(pc);</span><br></pre></td></tr></table></figure>
<p>在倒数第二行打点，截图如下：</p>
<p><img src="http://7xnwpq.com1.z0.glb.clouddn.com/diy-deser.png" alt="diy-deser"></p>
<p>没截图没毛病啊，很正常啊。我还专门测试了<code>SerializationUtils</code>版的序列化方式(把上面的注释去掉)，发现结果也很正常，这尼玛到底是怎么回事。实际上，<code>SerializationUtils</code>也就是jdk自带的<code>ObjectOutputStream</code>和<code>ObjectInputStream</code>的简单封装。</p>
<p>在我走投无路之际，正准备研究<code>instanceof</code>的工作原理的时候，脑中闪过一道灵感——难道是classloader的问题？说干就干，debug得到如下情况：</p>
<p><img src="http://7xnwpq.com1.z0.glb.clouddn.com/classloader-1.png" alt="classloader-1"><br><img src="http://7xnwpq.com1.z0.glb.clouddn.com/classloader-2.png" alt="classloader-2"></p>
<p>终于发现问题所在了，原来两个classloader不一样，而<code>instanceof</code>是对同一个classloader而言的。再确定原因后，借助强大的google发现了这是Spring Boot DevTools的一个限制，相关的文档链接: <a href="http://docs.spring.io/spring-boot/docs/1.4.2.RELEASE/reference/htmlsingle/#using-boot-devtools-known-restart-limitations" target="_blank" rel="noopener">http://docs.spring.io/spring-boot/docs/1.4.2.RELEASE/reference/htmlsingle/#using-boot-devtools-known-restart-limitations</a></p>
<p>原话是这样的：</p>
<blockquote>
<p>Restart functionality does not work well with objects that are deserialized using a standard ObjectInputStream. If you need to deserialize data, you may need to use Spring’s ConfigurableObjectInputStream in combination with Thread.currentThread().getContextClassLoader().<br>Unfortunately, several third-party libraries deserialize without considering the context classloader. If you find such a problem, you will need to request a fix with the original authors.</p>
</blockquote>
<p>DevTools是Spring Boot中一个很有用的工具，可以自动帮你重启应用，而不用你每次重启应用来debug，提高了生产效率。具体的用法可以参考相关的文档。这里的限制条件说的很清楚了，重启功能不能和使用标准的<code>ObjectInputStream</code>来反序列对象一起使用，如果你非要使用，那么请从线程的上下文中来获取classloader。</p>
<p>看到这里我瞬间明白了。因为devtools使用两个classloader，你工程中使用的第三方jar包被一个叫”base”的classloader所加载，而你正在开发的代码被一个叫”restart”的classloader所加载。如果检测到你的classpath路径下文件有变化，restart就会重新加载你工程的类。这样做以后能提高你的类加载速度，这在开发阶段是很有用的一个功能。</p>
<p>既然知道了原因，就很好解决了。因为我目前的工程比较小，而且只是一个restful后端应用，所有devtools对我的应用帮组不大。注释掉devtools依赖后就解决了上面的问题。如果你想使用这个工具，同时又有反序列化的需求，有两种方式解决：</p>
<ol>
<li>自定义一个<code>ObjectInputStream</code>，重写<code>resolveClass</code>方法，也可以使用Spring提供的<code>ConfigurableObjectInputStream</code>类。然后从<code>Thread.currentThread().getContextClassLoader()</code>获取classloader就可以解决该问题。</li>
<li>配置<code>spring-devtools.properties</code>文件，把你使用的第三方序列化工具也加入<code>restart　classloader</code>的控制范围内就行了。</li>
</ol>
<p>这两种方法均可以在Spring Boot的官方文档中有详细描述：<a href="http://docs.spring.io/spring-boot/docs/1.4.2.RELEASE/reference/htmlsingle/#using-boot-devtools" target="_blank" rel="noopener">http://docs.spring.io/spring-boot/docs/1.4.2.RELEASE/reference/htmlsingle/#using-boot-devtools</a>。</p>
<p>总结，从发现问题到定位原因耗时两个多小时，还是要加强对基础概念的深入理解才能快速定位原因啊！</p>
<p>文本的示例demo我已上传到github，有兴趣的同学可以下载自己debug一下：<a href="https://github.com/mymonkey110/boot-demo.git" target="_blank" rel="noopener">https://github.com/mymonkey110/boot-demo.git</a></p>
<p>参考资料:</p>
<p><a href="http://docs.spring.io/spring-boot/docs/1.4.2.RELEASE/reference/htmlsingle/#using-boot-devtools" target="_blank" rel="noopener">Spring Boot官方手册</a><br><a href="https://github.com/spring-projects/spring-boot/issues/3805" target="_blank" rel="noopener">spring-boot issue</a><br><a href="http://stackoverflow.com/questions/30795262/redis-serialization-and-deserialization" target="_blank" rel="noopener">redis serialization</a><br><a href="http://stackoverflow.com/questions/37977166/java-lang-classcastexception-dtoobject-cannot-be-cast-to-dtoobject" target="_blank" rel="noopener">classcastexception</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/debug/">debug</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/debug/">debug</a><a href="/tags/springboot/">springboot</a><a href="/tags/deserialized/">deserialized</a><a href="/tags/redis/">redis</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/15/架构为什么会腐化/" title="架构为什么会腐化" itemprop="url">架构为什么会腐化</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2016-12-14T16:33:22.000Z" itemprop="datePublished"> Published 2016-12-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>架构腐化一词我已经忘了从哪本书上看到的了，但是这个词给我留下了非常深刻的印象。关键在于“腐”一词，充分而又形象的描述了架构是怎样一步一步从简单清爽走向复杂污秽的。请允许我用“污秽”一词来描述一个糟糕的架构，因为糟糕的架构就像是一潭散发着臭味的淤泥，让你不想靠近，一旦涉入其中就会难以自拔，苦不堪言。</p>
<p>我相信所有的开发者都不希望自己的参与项目是一潭淤泥，但是为什么会出现这么多糟糕的架构呢？难道是项目最初的设计者经验不够，又或者项目开发周期太赶？我认识事实并非如此。现在，软件开发者的水平都普遍提高了，因为我们有前人那么多经验可以借鉴，连刚毕业的大学生也知道用MVC模式来搭建框架。难道是MVC模式太挫了，不够用，实际上80%的项目用MVC模式足以应对。那到底是什么原因导致了项目腐化呢？我认为有以下三个原因：</p>
<h3 id="1-不理解项目的业务价值"><a href="#1-不理解项目的业务价值" class="headerlink" title="1. 不理解项目的业务价值"></a>1. 不理解项目的业务价值</h3><p>实际上，几乎所有的软件（尤其是商业软件）都有其所属的业务价值，理解你所开发的软件的业务价值对项目的成功来说至关重要。我发现很多程序员对业务需求不屑一顾，而对那些所谓的非功能性需求盲目的崇拜和追捧，其实这是一种本末倒置的行为。</p>
<p>现实世界是一个商业的世界，而商业世界则会充斥着各种各样的业务逻辑。理解这些业务逻辑会极大地增加你的见识、拓宽你的视野。如果你是一个在金融行业工作的程序员，那么长时间在金融领域工作的精力将极大地提高你的市场竞争力。但是如果你不愿意花时间去学习金融领域的知识，而是去盲目的追求最新的技术，那么其实你是丢芝麻捡西瓜，浪费了这个行业带个你的附加价值。我不是不鼓励程序员瞎折腾，实际上我自己有时候也喜欢瞎折腾，倒腾一些新玩意，这视乎是程序员的一种天性。我的意思是说不要放弃了解自己所在行业/领域的知识视为不见，而盲目的追求其他的“高大上”的技术。</p>
<p>为什么说理解项目的业务价值至关重要呢，那是因为只有理解了其业务价值你才能识别出来这个项目的核心领域所在，这样这个项目才不会走偏。传统的软件开放流程中有一个非常重要的角色存在，叫做“业务分析员”，他的工作在项目的概要设计和详细设计解决十分重要。虽然我也没见过有专职的人员干这个，但是这却是非常重要的一个角色。他会帮你分析你的业务，和产品经理沟通，理解产品的真正意图。在这个沟通过程中，你的领域模型也就逐渐的清晰起来了，哪些是核心哪些是支撑部分也就清楚了。</p>
<p>有些程序员在接到产品需求后立马就开始工作了，吭哧吭哧地撸袖子上阵，我认为这是十分要不得的。接到产品需求的第一反应不是要想着我要建哪些表哪些字段，而是要多问问自己这个需求是干啥的，产品经理真正的意图是啥，为什么要我来做，跟我的系统有啥关系。千万不要盲从产品经理的话，实际上有些时候他们自己也不知道自己要干啥，为啥要这么干。这个时候必要的交流是不可少的，随着对话的深入，你和产品对真是的需求都会有着更深地认识。新人和实习生在这方面经验往往不足，此时最好找一个比较资深的程序员帮你梳理一下业务流程。</p>
<p>相反，如果你不知道你的系统的业务价值或者核心所在，什么需求你都来着不拒，那么恭喜你，你的系统正在腐化。当你在抱怨说“为什么这个业务要放在我这里”，“这个我有什么关系”之类的话的时候就可以闻到一丝“腐化”的闻到。你可能会说项目工期紧、人手太少、需求太多之内的外部原因，所以临时地先加到系统中搞一下。Ok，这没有任何问题。但是我还是要说，你知道你的系统的核心价值所在吗？如果你的回答是Yes，那么恭喜你，你是一名合格的程序员了。否则，你可能需要学习一下技术之外的东西的了－那就是沟通。</p>
<h3 id="2-过度设计"><a href="#2-过度设计" class="headerlink" title="2. 过度设计"></a>2. 过度设计</h3><p>软件开发的头号敌人就是复杂度。现在软件开发是如此的困难，动不动就有十几万行代码出现，但是现实世界就是如此的复杂，不会因为你采用某种架构或者奇淫巧技就能把代码行数降下来。好的架构设计会将系统的复杂度控制在一个合理的范围之内，因为人所能驾驭的代码行数最多也就几十万行，如果一个系统的代码行数达到百万行，那么这个系统就很危险了。现在微服务架构如此火爆，不得不说有这方面的原因。</p>
<p>如果你在设计一个新系统，那么我需要提醒你一定要控制好复杂度。一个好的系统的核心域往往是简单的、直观的，其他人很快就能理解其核心的工作原理。如果一开始系统设计的十分复杂，那么这个系统的扩展性就会很差，后续的维护将不可想象。但是是不是在设计之初就完全不考虑后续的变化了呢？我的建议是你只需要把你的核心领域模型建好，多问问自己系统最核心的价值是提供什么服务的，照着这个方向去设计，那么你的系统就不会走偏。灵活性和可扩展型往往只是领域模型的延伸，这是一个水到渠成的过程。</p>
<p>非要给个度的话，我认为5%刚刚好。不要出现超过5%的跟你本次需求无关的概念和行为，而且这5%还是你能确定在不久的将来就会使用的扩展。</p>
<p>还是那句话，好的设计往往是简单的，复杂是万恶之源。</p>
<h3 id="3-懒于重构"><a href="#3-懒于重构" class="headerlink" title="3. 懒于重构"></a>3. 懒于重构</h3><p>过度设计不好，完全不设计也不行，尤其是随着敏捷开发的流行，持续交付优于提前设计的思想逐步流行。现在软件交付速度是如此之快，很有可能刚刚设计好的系统，下个月就全变样了。应对这种变化的唯一方法就是持续重构。</p>
<p>没有任何设计能预料到未来的变化，代码可能会发生变化。新的功能会持续的添加进来，老的功能也在持续的改变。而且每次迭代或者交付，都可能会对核心领域产生影响。千万不要对这种影响视而不见，因为它在改变着你的领域模型。正确地方式是经常调整领域模型以适应新功能所带来的变化，虽然每次调整的幅度可能很小，但是这却能让你的领域模型处于健康的工作状态。没有领域模型或者系统在一开始就是完美的，之所以它们能在后续的迭代过程中良好的工作离不开不断地重构。</p>
<p>重构不是等到你的系统无药可救的时候才想到的事，而是应该在其不断开发过程中一直进行的工作。如果说持续交付提高了你系统的竞争力，那么持续重构则是这种竞争力的有力保障！</p>
<p>以上三点是我认为架构腐化最致命的原因，很多思想来源于<a href="https://en.wikipedia.org/wiki/Domain-driven_design" target="_blank" rel="noopener">DDD</a>、<a href="https://book.douban.com/subject/1229923/" target="_blank" rel="noopener">重构</a>和<a href="https://en.wikipedia.org/wiki/Agile_software_development" target="_blank" rel="noopener">敏捷开发</a>。linus torvalds曾经说过：</p>
<blockquote>
<p>Talk is cheap. Show me the code.</p>
</blockquote>
<p>我认为<em>Talk is not cheap</em>, 好的思想和开发方式价值连城，想好了再做会提高你的工作效率，从而提升你的生活品质。</p>
<p>这篇文章从下笔到完成，拖了半个多月了，期间琐事太多。对这个话题有兴趣的朋友我们可以留言讨论。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/架构设计/">架构设计</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/DDD/">DDD</a><a href="/tags/架构设计/">架构设计</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/10/18/值对象的威力/" title="值对象的威力" itemprop="url">值对象的威力</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2016-10-18T15:27:45.000Z" itemprop="datePublished"> Published 2016-10-18</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>值对象是DDD中非常重要的一种技术，掌握这种技术让你写代码事半功倍，体会到OO的精妙。如果你是一名Java程序员，我相信你或多或少地见过值对象了，只是你没有意识到而已。</p>
<p>引用维基百科的<a href="https://en.wikipedia.org/wiki/Value_object" target="_blank" rel="noopener">解释</a>：</p>
<blockquote>
<p>In computer science, a value object is a small object that represents a simple entity whose equality is not based on identity.</p>
</blockquote>
<p>字面意思就是，值对象是一个小对象，它代表着一个简单的实体，而实体的相等性不取决于它的ID。</p>
<p>刚刚接触OO编程的新手看完上面的解释相信直接是懵逼的，跟我接触这一概念时一样。如何理解值对象了，我还是举一个栗子。比如我们在做一个短信推送的服务，需要根据目标用户的手机号推送到相应的短信网关。我们定义了一个根据手机号推送短信的interface，很有可能我们是这么设计：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">void sendMessage(String phone, String message) &#123;</span><br><span class="line">    if(StringUtils.isBlank(phone) &amp;&amp; phone.length()!=13) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;phone format error:&quot;+phone);</span><br><span class="line">    &#125;</span><br><span class="line">    if(phone.starts(&quot;134&quot;)) &#123;</span><br><span class="line">        sendMessageToChinaMobileGateway(phone,message);</span><br><span class="line">    &#125;else if(phone.starts(&quot;130&quot;)&#123;</span><br><span class="line">        sendMessageToChinaUnionGateway(phone,message);</span><br><span class="line">    &#125;else if(phone.starts(&quot;189&quot;) &#123;</span><br><span class="line">        sendMessageToChinaTelecomGateway(phone,message);</span><br><span class="line">    &#125;else &#123;</span><br><span class="line">        throw new RuntimeException(&quot;unknown phone range&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的过程我们只考虑3个号码段，134(移动)\130(联通)\189(电信)，其他的号码短我们暂不处理。上面的处理方式有什么问题？ </p>
<p>如果我们的工程里面只有一个地方用的<code>phone</code>的概念，也只有一个地方对<code>phone</code>所属的号码短进行判断，那么没问题。上面的写法没有任何问题，因为它是一个简单问题。但是如果你在做一个短信推送的应用，在你的工程里面会只有一个地方会使用<code>phone</code>这个概念吗，也之有一个地方需要判断号码短吗？ 显然不可能。</p>
<p>有人可能会争论说，不就是判断号码归属吗？我可以搞一个类似<code>PhoneQueryService</code>之类的查询类，再提供一个<br><code>Operator queryBelong(String phone)</code>的interface不就搞定了吗？ 当然，这么做也没有问题。但是当你的问题域逐渐变得复杂的时候，你就会开始有些不舒服了。因为每一个出现<code>phone</code>的地方，你发现基本上都会需要<code>PhoneQueryService</code>，但是他们在代码上又是两个东西。这种做饭的滥用最终会导致<code>Fat Service</code>的出现，代码的复用性会急剧降低。</p>
<p>究其原因，是因为我们把<code>phone</code>这个概念和<code>phone</code>的行为给拆开了。你可以用<code>String</code>代表任何字符类型，可以是<code>phone</code>，也可以是<code>name</code>，基本上这种类型可以代表任何东西。使用你API的人无法从中得到任何信息，除了你把变量名称叫做<code>phone</code>以外。同时，判断手机号网段这个动作是和<code>phone</code>本身强相关的，为什么不把这个动作加到<code>phone</code>里面了？！ 现在，我们重构一下代码，得到类似下面的代码结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">class Phone &#123;</span><br><span class="line">   private String phoneNumber;</span><br><span class="line">   public Phone(String phoneNumber) &#123;</span><br><span class="line">      if(!validate(phoneNumber)) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;phone format error:&quot;+phone);</span><br><span class="line">      &#125;</span><br><span class="line">      this.phoneNumber = phoneNumber;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   public static boolean validate(String phoneNmber) &#123;</span><br><span class="line">      //验证逻辑</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   public boolean isMobile() &#123;</span><br><span class="line">        return phoneNumber.starts(&quot;134&quot;);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   public boolean isUnion() &#123;</span><br><span class="line">         return phoneNumber.starts(&quot;130&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public boolean isTelecom() &#123;</span><br><span class="line">        return phone.starts(&quot;189&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String getRawPhone() &#123;</span><br><span class="line">        return this.phoneNumber;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public boolean isSameWith(Phone other) &#123;</span><br><span class="line">        return other!=null&amp;&amp;this.phoneNumber.equals(other.getRawPhone());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们新增了一个叫<code>Phone</code>的类，并加入了判断网段归属的逻辑。引入这个类以后<code>sendMessage()</code>发生了什么变化呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void sendMessage(Phone phone, String message) &#123;</span><br><span class="line">    checkNotNull(phone);</span><br><span class="line">    </span><br><span class="line">    if(phone.isMobile()) &#123;</span><br><span class="line">        sendMessageToChinaMobileGateway(phone,message);</span><br><span class="line">    &#125;else if(phone.isUnion())&#123;</span><br><span class="line">        sendMessageToChinaUnionGateway(phone,message);</span><br><span class="line">    &#125;else if(phone.isChinaTelecom()) &#123;</span><br><span class="line">        sendMessageToChinaTelecomGateway(phone,message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>咋一看，代码好像没有怎么减少啊。对于这个interface来说代码确实没有减少，反而我们还新加一个类。但是现在看看我们获得了什么：</p>
<ul>
<li>首先，方法签名变了。不在用String了，取而代之的是<code>Phone</code>类型。这对使用者的约束更强了，我们也再也不用判断phone是否合法了。</li>
<li>其次，判断网段归属和<code>phone</code>合在一起了，这样我需要判断归属运营商的时候直接调用<code>phone</code>的方法就行了。</li>
</ul>
<p>现在，我们已经得到了一个值对象了，那就是<code>Phone</code>。它是一个小对象，代表了手机号这个概念，它的相等性是基于其业务属性的，而不是ID，而且值对象根本就没有ID这个概念。</p>
<p>值对象最大的好处在于增加了代码复用，同时它也是类型安全的（这一点和我之前提到了enum类似）。如果你只在一个地方使用值对象，那么你是不会体会到值对象带来的好处的。但是，每当你的代码应用一次值对象，你就会收获值对象带来的好处。<strong><em>用的越多，收益越大</em></strong>，这一点和单元测试比较类似。使用值对象的另外一个好处就是前置的安全校验，尤其是你在编写SDK或者开放接口的时候。因为你无法知道使用者会如何使用你的API，那么通过值对象来获得一个前置的安全校验有着非常大的好处。</p>
<p>值对象用在什么地方呢？ 我个人的经验就是，如果在你的工程中反复出现一个具体的概念（往往跟现实生活有关），而且这个概念中涉及的行为是某种确定性的（比如你知道了手机号，就知道对应的运营商一样），那么你可以考虑一下值对象。引用《实现领域驱动设计》中关于值对象特征的定义:</p>
<ul>
<li>描述了领域中的一件东西</li>
<li>不可变的</li>
<li>将不同的相关属性组合成了一个概念整体</li>
<li>当度量和描述改变时，可以用另外一个值对象予以替换</li>
<li>可以和其他值对象进行相等性比较</li>
<li>不会对协作对象造成副作用</li>
</ul>
<p>最为重要的就是它描述了领域中的某件东西，并且它是不可变的。值对象一旦创建就不会发生变化，如果你需要表示另外一个东西，用另外一个值对象来代替它。</p>
<p>值对象是DDD中非常重要的部分，我们应该尽可能对使用值对象来建模，因为它是易于使用和替换的。但是值对象的实例化确实一个令人头疼的问题，尤其是聚合中存在1对多的关系时。由于这些内容涉及到DDD的多方面的知识，我不在这里展开讨论了。后续会专门讲值对象的持久化问题。之所以在讲DDD之前首先讲值对象，因为它还是少数几个可以完全脱离DDD并不失其威力的利器。就算你完全不了解DDD，也可以非常顺手的使用值对象。</p>
<p>说了这么多，我相信你也对值对象有个具象的认识了。纸上得来终觉浅，不如看看你现有的代码中哪些可以用值对象来代替吧！</p>
<p>参考文献：</p>
<p><a href="https://en.wikipedia.org/wiki/Value_object" target="_blank" rel="noopener">Wikipedia值对象的定义</a><br><a href="http://martinfowler.com/bliki/ValueObject.html" target="_blank" rel="noopener">Martin Fowler值对象的解释</a><br><a href="https://book.douban.com/subject/25844633/" target="_blank" rel="noopener">实现领域驱动设计</a><br><a href="https://www.infoq.com/presentations/Value-Objects-Dan-Bergh-Johnsson" target="_blank" rel="noopener">Power Use of Value Objects in DDD</a>: 强烈推荐</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/DDD/">DDD</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/DDD/">DDD</a><a href="/tags/Value-Object/">Value Object</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/09/20/论Enum的重要性/" title="论Enum的重要性" itemprop="url">论Enum的重要性</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Michael Jiang" target="_blank" itemprop="author">Michael Jiang</a>
		
  <p class="article-time">
    <time datetime="2016-09-20T14:18:11.000Z" itemprop="datePublished"> Published 2016-09-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们都知道Java中有一种数据类型是枚举类，实际上很多强类型的语言都有枚举。但是很多人对枚举类不那么重视，或者不能正确地应用枚举，也就不能发挥其威力了。这里分享一下我对枚举的理解，及其常见的用法。</p>
<p>既然Java专门为枚举建立了类型，那么我们应该在什么时候去使用enum呢，我认为在以下两个场景中可以尝试使用。</p>
<h4 id="1-封装有限的的变化"><a href="#1-封装有限的的变化" class="headerlink" title="1. 封装有限的的变化"></a>1. 封装有限的的变化</h4><p>相信很多人都遇到这样一个场景，我们有一个父类，父类下面有几个子类，而这几个子类是可以确定的。我们并不想父类被不相干的类所继承，那么我们可以通过enum来限制子类。实际上你想把代码控制在预期的范围之类时，都可以通过enum来达到效果。</p>
<h4 id="2-状态代码"><a href="#2-状态代码" class="headerlink" title="2. 状态代码"></a>2. 状态代码</h4><p>我们经常会遇到使用状态码的情况，例如在任务处理过程中。我发现很多人喜欢使用int或者long来表示状态码，然后通过定义对应的变量来表示其意义。不是说这种方式不好，但我从中嗅出了一丝坏味道。如果通过int或者long来表示状态码，如果出现了不在业务范围内的值该怎么办？为什么状态码不能直接表示其意义，还需要通过文档来说明呢？我一直比较推崇Self-Explained的编程习惯，代码和文档合二为一。</p>
<p>那么使用Enum有什么好处了，我们为什么要用Enum呢？相比于int或者string，enum最大的优势就是有它是类型安全的。如何理解类型安全呢，我举一个例子：很多APP都有第三方登陆的功能，服务器要根据客户端传过来的登陆类型(type)来调用对应平台的接口来获取用户信息。我的代码是这样写的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class TPAccountRouterImpl implements TPAccountRouter &#123;</span><br><span class="line">    @Resource</span><br><span class="line">    @Qualifier(&quot;wbAccountResolver&quot;)</span><br><span class="line">    private TPAccountResolver wbTPAccountResolver;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    @Qualifier(&quot;wxAccountResolver&quot;)</span><br><span class="line">    private TPAccountResolver wxTPAccountResolver;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    @Qualifier(&quot;qqAccountResolver&quot;)</span><br><span class="line">    private TPAccountResolver qqTPAccountResolver;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public TPAccount getAccountInfo(final String tuid, String accessToken, AccountType accountType) throws TPException &#123;</span><br><span class="line">        TPAccountResolver tpAccountResolver;</span><br><span class="line"></span><br><span class="line">        switch (accountType) &#123;</span><br><span class="line">            case WB:</span><br><span class="line">                tpAccountResolver = wbTPAccountResolver;</span><br><span class="line">                break;</span><br><span class="line">            case WX:</span><br><span class="line">                tpAccountResolver = wxTPAccountResolver;</span><br><span class="line">                break;</span><br><span class="line">            case QQ:</span><br><span class="line">                tpAccountResolver = qqTPAccountResolver;</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                throw new TPException(&quot;unknown account type&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return tpAccountResolver.getAccountInfo(tuid, accessToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>TPAccountRouter</code>是一个账号解析的路由器，根据<code>AccountType</code>来调用对应平台的解析器来解析。配合switch-case语法，利用策略模式我们就可以写出一个还算优美的代码。如果把<code>accountType</code>换成<code>int</code>会怎样？那么我们不得不加上一句及其烦人的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if(accountType&lt;0 || accountType&gt;3) &#123;</span><br><span class="line">  throw new IllegalArgumentException(&quot;type illegal&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>保护性代码，同时将case子句换成一个一个静态常量，最后还在API文档上配上说明，1,2,3各代表什么意义。我相信大家一定能感受出来两种代码写法带来的区别。</p>
<p>另外一个有点，我认为就是enum的self-explain特性，上面的例子中也直观的反应了这一点。Enum结合了int和String的优点，并将其发扬光大。</p>
<p>关于Enum怎么用，网上有很多的介绍，可以参考这篇文章：<a href="http://www.cnblogs.com/happyPawpaw/archive/2013/04/09/3009553.html" target="_blank" rel="noopener">http://www.cnblogs.com/happyPawpaw/archive/2013/04/09/3009553.html</a>，还是比较全面的。最常用的就是直接申明各个枚举值，基本上能满足大部分业务场景了。也有很多场景下，我们会在enum中加入成员变量，这是因为业务中存在和Enum相对应的文档和动作。再举一个我写过的代码例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstractCheckedException extends Exception &#123;</span><br><span class="line"></span><br><span class="line">    private static final long serialVersionUID = -3143228702981231790L;</span><br><span class="line"></span><br><span class="line">    public AbstractCheckedException() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected abstract ErrorCode errorCode();</span><br><span class="line"></span><br><span class="line">    public int code() &#123;</span><br><span class="line">        return errorCode().code();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String msg() &#123;</span><br><span class="line">        return errorCode().msg();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static int successCode() &#123;</span><br><span class="line">        return ErrorCode.SUCCESS.code();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public enum ErrorCode &#123;</span><br><span class="line">        SUCCESS(1000, &quot;success&quot;),</span><br><span class="line">        PARAM_ERROR(1001, &quot;parameter error&quot;),</span><br><span class="line">        ILLEGAL_REQUEST(1002, &quot;illegal request&quot;),</span><br><span class="line">        SYS_ERROR(1003, &quot;system error&quot;),</span><br><span class="line">        NAMESPACE_NOT_FOUND(2001, &quot;namespace not found&quot;),</span><br><span class="line">        NAMESPACE_ALREADY_EXIST(2002, &quot;namespace already exist&quot;),</span><br><span class="line">        APP_NOT_FOUND(2003, &quot;app not found&quot;),</span><br><span class="line">        APP_ALREADY_EXIST(2004, &quot;app already exist&quot;),</span><br><span class="line">        TASK_NOT_FOUND(2005, &quot;task not found&quot;),</span><br><span class="line">        TASK_ALREADY_EXIST(2006, &quot;task already exist&quot;),</span><br><span class="line">        CRON_EXPRESSION_ERROR(2007, &quot;cron expression error&quot;),</span><br><span class="line">        ZOOKEEPER_ERROR(3001, &quot;zookeeper error&quot;),</span><br><span class="line">        NODE_NOT_EXIST(3002, &quot;node not exist&quot;),</span><br><span class="line">        NODE_ALREADY_EXIST(3003, &quot;node already exist&quot;),</span><br><span class="line">        UNKNOWN_ERROR(9999, &quot;unknown error&quot;);</span><br><span class="line"></span><br><span class="line">        private int code;</span><br><span class="line">        private String msg;</span><br><span class="line"></span><br><span class="line">        ErrorCode(int code, String msg) &#123;</span><br><span class="line">            this.code = code;</span><br><span class="line">            this.msg = msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public int code() &#123;</span><br><span class="line">            return code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public String msg() &#123;</span><br><span class="line">            return msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static ErrorCode getErrorCode(int code) &#123;</span><br><span class="line">            for (ErrorCode it : ErrorCode.values()) &#123;</span><br><span class="line">                if (it.code() == code) &#123;</span><br><span class="line">                    return it;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return UNKNOWN_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我在<a href="https://github.com/mymonkey110/jscheduler" target="_blank" rel="noopener">jscheduler</a>中封装了高层了受检异常，这点收到了Zookeeper中<code>KeeperException</code>的启发。我在ErrorCode中加入了code和message，因为code和message是和这个枚举绑定的，放到枚举中再合适不过呢，我将之称为文档的绑定。还有情况是因为业务动作和枚举相关，比如第三方登陆的例子，我们完全可以第三方登陆接口的URL放到<code>AccountType</code>中，然后后续的解析方法直接从中取的URL进行调用就行，因为这个解析方法是和Enum一一对应的。这样的例子实在太多了，不胜枚举。</p>
<p>总之，如果你有一类相识的业务场景，并且这些业务场景只有有限的变化，是可以预期的，那么建议你考虑一下使用Enum。相信我，它值得尝试！</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Better-code/">Better code</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/enum/">enum</a><a href="/tags/OO/">OO</a><a href="/tags/代码技巧/">代码技巧</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Better-code/" title="Better code">Better code<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/C/" title="C#">C#<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/DDD/" title="DDD">DDD<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/debug/" title="debug">debug<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/云计算/" title="云计算">云计算<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/安全/" title="安全">安全<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/架构设计/" title="架构设计">架构设计<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/生活/" title="生活">生活<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/编程心智/" title="编程心智">编程心智<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/编程感悟/" title="编程感悟">编程感悟<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/网络/" title="网络">网络<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/翻译/" title="翻译">翻译<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/踩过的那些坑/" title="踩过的那些坑">踩过的那些坑<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/部署/" title="部署">部署<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/DDD/" title="DDD">DDD<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/cloud/" title="cloud">cloud<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/云计算/" title="云计算">云计算<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/debug/" title="debug">debug<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/架构设计/" title="架构设计">架构设计<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/架构/" title="架构">架构<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/领域事件/" title="领域事件">领域事件<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/event/" title="event">event<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/life/" title="life">life<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/访问控制/" title="访问控制">访问控制<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/DSL/" title="DSL">DSL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/系统架构/" title="系统架构">系统架构<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/代码架构/" title="代码架构">代码架构<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/编程心得/" title="编程心得">编程心得<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/计费/" title="计费">计费<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/CQRS/" title="CQRS">CQRS<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C-tcp-udp-network/" title="C# tcp udp network">C# tcp udp network<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/感悟/" title="感悟">感悟<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/btrace/" title="btrace">btrace<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2020 
		
		<a href="/about" target="_blank" title="Michael Jiang">Michael Jiang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
